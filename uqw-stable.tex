
\section{From uniform quasi-wideness to stability}\label{sec:stable}

In this section we focus on proving the following result, observed earlier by Adler and Adler~\cite{adler2014interpreting}.

\begin{theorem}\label{thm:uqw-stable}
	Let $\cal C$ be a uniformly quasi-wide class of graphs.
	Then $\cal C$ is stable. % More precisely, if $\phi(\bar u,\bar v)$ is a formula with $d$ free variables and quantifier rank $q$, and $N^d(r,m)$ and $s^d(r)$ are as in Proposition~\ref{prop:uqw-tuples}, then for all graphs $G\in\cal C$,  the ladder index of $\phi$ is at most $N^d(2r,(2T)^d)$,
% where $r= 7^q$,
%  $T$ is the number of all quantifier rank $q$ types with one free  variable over the signature of  graphs colored with $s^d(2r)$ colors.
%\marginpar{shall we recall the definition of stability and ladders?}
\end{theorem}

Recall that a class $\cal C$ is stable if and only if for every first-order formula $\varphi(\bar x,\bar y)$, its ladder index over graphs from $\cal C$ is bounded by a constant depending only on $\cal C$ and $\varphi$;
see \cref{sec:intro} to recall the background on stability.
Thus \cref{thm:uqw-stable} is implied by \cref{thm:new-stable} (stated in \cref{sec:intro}), and is weaker in the following sense: \cref{thm:new-stable} asserts in addition that there is a computable bounds on the ladder index
of any formula that depends only on the size of an excluded clique minor on a levels bounded in terms of formula's quantifier rank and number of free variables. At the end of the proof we argue that
the obtained bounds in fact also imply the stronger statement of \cref{thm:new-stable}, but for the clarity of presentation we find it more instructive to work with the cleaner formulation of \cref{thm:uqw-stable}.

The plan is as follows. In \cref{sec:uqw-tuples} we formulate a variant of uniform quasi-wideness tailored to tuples of vertices. Using this and Gaifman's Locality Theorem, we prove \cref{thm:uqw-stable} in \cref{sec:uqw-stable}.


\subsection{Uniform quasi-widness for tuples}\label{sec:uqw-tuples}
Fix a graph $G$, the dimension $d\in\N$, and the radius $r\in \N$.
If $S\subset V(G)$ is a set of vertices and $A\subset V(G)^d$ is a set of $d$-tuples of vertices,
then we say that $A$ is \emph{mutually $r$-independent} in $G-S$ 
if for every two distinct $(u_1,\ldots,u_d),(v_1,\ldots,v_d)\in A$
and for all $1\le i,j\le d$, the distance between the vertices $u_i$ and $v_j$ in the graph $G-S$
is larger than $r$. Throughout this section we use the convention that if $x\in S$, then the distance in $G-S$ between $x$ and any vertex, including~$x$ itself, is infinity. 
For instance, in the definition above, the tuples from $A$ may contain vertices of~$S$, and such a vertex is considered infinitely far from every vertex.

We now prove the following proposition, which can be viewed as an extension of uniform quasi-wideness to tuples.
The proof is based on translating the approach of Podewski and Ziegler~\cite{podewski1978stable} to the finite.

\begin{proposition}\label{prop:uqw-tuples}
	Let $\cal C$ be a uniformly quasi-wide class of graphs and $d\in\N$ be an integer.
	Then there are functions $N^d\colon \N\times\N\to\N$ and $s^d\colon \N\to\N$
	such that for all $r,m\in\N$ and all subsets $A\subset V(G)^d$
	with $|A|\ge N^d(r,m)$ there  is a set $S\subset V(G)$
	of size $|S|\le s^d(r)$ and a subset $B\subset A$ of size $|B|\ge m$ which is mutually $r$-independent in $G-S$.
\end{proposition}

The rest of this section is devoted to the proof of \cref{prop:uqw-tuples}.
Fix a uniformly quasi-wide class $\cal C$ and functions $N\colon \N\times\N\to \N$
	and $s\colon \N\to\N$ as in the definition of uniform quasi-wideness.
	Let $d\in \N$ be a fixed dimension.
		For a fixed graph $G\in \cal C$  and
	  coordinate $i\in\set{1,\ldots,d}$, let $\pi_i$ denote the projection from $V(G)^d$ onto the $i$th coordinate.

	


\begin{lemma}\label{lem:step1} For any $r,m\in \N$ there is an integer $K(r,m)$ such that
	for any given $A\subset V(G)^d$ with $|A|\ge K(r,m)$,
	there is a set $B\subset A$ with $|B|\ge m$ and a set $S\subset V(G)$ with $|S|\le d\cdot s(r)$, 
	such that for each coordinate $i\in\set{1,\ldots,d}$ and all distinct $\bar x,\bar y\in B$,
 $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at distance greater than $r$ in $G-S$. 
\end{lemma}
\begin{proof}
We will iteratively apply the following claim.

%Let $f\colon \N\to \N$ be defined as $f(m)=N(r,m)\cdot m$ for $m\in\N$.

\begin{claim}\label{claim:ith-coord}
Fix a coordinate $i\in\set{1,\ldots,d}$, an integer $m'\in\N$, and a  set $A'\subset V(G)^d$ with  $|A'|\ge N(r,m')\cdot m'$.
Then there is a set $B'\subset D$ with $|B'|\ge m'$
and a set $S'\subset V(G)$ with $|S'|\le  s(r)$, such that for all distinct $\bar x,\bar y\in B$,
 $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at distance greater than $r$ in $G-S$. 
\end{claim}
\begin{clproof}
We consider two cases.

If $\pi_i(A')\subset V(G)$ has at least $N(r,m')$ elements, then we apply the definition of uniform quasi-wideness to $\pi_i(A')\subset V(G)$. This yields sets $S'\subset V(G)$ and $B''\subset \pi_i(A')$
such that $|B''|\ge m'$, $|S'|\le s(r)$, and $B''$ is $r$-independent in $G-S'$. 
Let $B'\subseteq A'$ be a subset of tuples constructed as follows: for each $u\in B''$, include in $B'$ one arbitrarily chosen tuple $\bar x\in A'$ such that $\pi_i(\bar x)=u$.
Clearly $|B'|=|B''|\ge m'$ and for all distinct $\bar x,\bar y\in B'$, we have that $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are distinct and at distance greater than $r$ in $G-S$; this is because $B''$ is $r$-independent
in $G-S$. Hence $B'$ and $S'$ satisfy all the required properties.

If $\pi_i(A')$ has less than $N(r,m')$ elements, then choose the element $a\in\pi_i(A')$ whose inverse image $\pi_i^{-1}(\set a)\cap A'$ has the largest cardinality. Let $S'=\set{a}$ 
and let $B'=\pi_i^{-1}(\set a)$. Then $$|B'|\ge \frac{|A'|}{|\pi_i(A')|}\ge \frac{|A'|}{N(r,m')}\ge \frac {N(r,m')\cdot m'}{N(r,m')}=m',$$
and $|S'|=1$. Observe that $\pi_i(\bar x)=a$ for all $\bar x\in A'$. As $a\in S$, by the adopted convention, $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at infinite distance for all distinct $\bar x,\bar y\in B$.
\end{clproof}

We proceed with the proof of \cref{lem:step1}.
Let $f(m')=N(r,m')\cdot m'$ for $m'\in\N$; by $f^k$ we denote the $k$-fold composition of $f$ with itself.
Let $A\subset V(G)^d$ be such that $|A|\ge f^d(m)$. 
Define $B_0=A$, $S_0=\emptyset$, and for $i=1,\ldots,d$,
let $B_{i}$ and $S_i$ be the $B'$ and $S'$ obtained from \cref{claim:ith-coord} applied to the set of tuples $B_{i-1}\subset V(G)^d$, the coordinate $i$, and $m'=f^{d-i}(m)$. 
The invariant is that $|B_i|\ge f^{d-i}(m)$.
In particular, 
taking $B=B_d$ and $S=S_1\cup\ldots \cup S_d$, we obtain that $|B|\ge m$ and $|S|\le d\cdot s(r)$, and, by construction, $\pi_i(B)$
is $r$-independent in $G-S$ for every coordinate $i\in\set{1,\ldots,d}$. Letting $K(r,m)=f^d(m)$ yields the lemma.
\end{proof}


\begin{lemma}\label{lem:step2}
	Let $B\subset V(G)^d$ and $S\subset V(G)$ be such that 
  %\begin{itemize}
	%\item
   for all $i\in \set{1,\ldots,d}$,
	$\pi_i(B)$ is $2r$-independent in $G-S$.
  % \item for each tuple $\bar a\in B$, the set of entries of $\bar a$ is $r$-independent in $G-S$.
%	\end{itemize}
	Then there is a set $C$ with $C\subset B$ 
	such that $C$ is mutually $r$-independent in $G-S$
	and $|C|\geq\frac{|B|}{d^2+1}$.
\end{lemma}
\begin{proof}
We construct a sequence $C_0\subset C_1\subset \ldots$ of subsets of $B$ which are mutually $r$-independent in $G-S$, as follows.

We start with $C_0=\emptyset$. Suppose that $C_s\subset B$ is 
 already constructed for some $s\ge 0$
 and is mutually $r$-independent in $G-S$; we construct $C_{s+1}$. With each element $a\in B-C_s$,
we associate an arbitrarily chosen function $f_a\colon \set{1,\ldots,d}^2\to C_s\cup \set{\bot}$
with the following properties:
\begin{itemize}
	\item If $f_a(i,j)=b$ then the $i$th coordinate of $a$
	and the $j$th coordinate of $b$ are at distance at most $r$
	in $G-S$.
	\item If $f_a(i,j)=\bot$ then there is no element $b\in C_s$ 
	such that the $i$th coordinate of $a$ and the $j$th coordinate of $b$ are at distance at most $r$ in $G-S$.	
\end{itemize}
Observe that whenever $a_1, a_2$ are two distinct elements of $B-C_s$,
then for all $i,j\in \set{1,\ldots,d}^2$, the values $f_{a_1}(i,j)$ and $f_{a_2}(i,j)$
cannot be equal to the same element $b\in C_s$:
otherwise, we would have that the $i$th coordinate of $a_1$
and the $i$th coordinate of $a_2$ are at distance at most $2r$
in $G-S$, which is impossible by the assumption on $B$.
In particular, if $|B-C_s|> |C_s|\cdot d^2$
then there must be some element  $a\in B-C_s$  
such that $f_a(i,j)=\bot$  for all $i,j\in\set{1,\ldots,d}$.
Let $C_{s+1}=C_s\cup \set a$.
By construction, $C_{s+1}$ is mutually $r$-independent in $G-S$.

We may repeat the construction as long as $|B|>|C_s|\cdot (d^2+1)=s\cdot (d^2+1)$, and we stop when this inequality no longer holds. Define the set $C$ as the last constructed set $C_s$.
By construction, $|C_s|=s\ge 
\frac{|B|}{d^2+1}$.	
\end{proof}

To finish the proof of \cref{prop:uqw-tuples},
given a set $A\subset V(G)^d$ and integers $r,m\in\N$,
first apply 
\cref{lem:step1} 
  with $r'=2r$ and
 $m'= m\cdot (d^2+1)$.
 Assuming that $|A|\ge K(r',m')$, 
we obtain a set $B\subset A$ with $|B|\ge m\cdot (d^2+1)$ and a set $S\subset V(G)$ with $|S|\le s(2r)$.
Apply \cref{lem:step2} to $B$ and $S$, yielding a set $C\subset B$ which is mutually $r$-independent in $G-S$ and has size at least $m$. This concludes the proof of \cref{prop:uqw-tuples},
where the obtained bounds are $N^d(r,m)=K(r',m')=K(2r,m\cdot (d^2+1))$ and $s^d(r)=d\cdot s(2r)$.


\subsection{Excluding long ladders}
\label{sec:uqw-stable}


We consider only finite sets of variables, and any mathematical object can be considered a variable 
(formally, whenever we want to treat an object $a$ as a variable, we introduce a variable $x_a$, where $x$ is a fixed special symbol).
If $\phi$ is a formula then it has a specified set of free variables.
By abuse of language, if $X$ is a set of variables and $\phi$
is a formula, when we say that $\phi$ \emph{has free variables} $X$
we allow the set of free variables of $\phi$ to be a subset of $X$.

If $X$ is a finite set and $V$ is a set, then $V^X$ denotes the set of functions from $X$ to $V$, and an element $v\in V^X$ will be sometimes called a \emph{tuple} 
or, in the case $X$ is a set of variables, a \emph{valuation} of $X$.
For two tuples
$v\in V^Y$ and $w\in  W^Z$, where $Y$ and $Z$ are disjoint, by
$v\oplus w$ we denote the set-theoretic union of the functions $v,w$,
which is a tuple $v\oplus w\in (V\cup W)^{Y\cup Z}$.
The image of a valuation $v$ is denoted by $\im(v)$.
If $V=V(G)$ for some graph $G$, then we can treat valuations of $X$ as tuples of length $|X|$ consisting of vertices of $G$, ordered in the same way according to any fixed enumeration of $X$.
Then we may say that a set of valuations is mutually $r$-independent in $G$, or in $G-S$ for some $S\subseteq V(G)$, meaning the notion discussed in the previous section.


Fix a formula $\phi$ with free variables $X$.
Given a valuation $v\in V(G)^X$, we write $G,v\models \phi$ to denote that $\phi$ is satisfied 
in the graph $G$ with valuation $v$, which is defined as usual in logic, by induction on the structure of $\phi$.

In this language,
assuming that  $X$ is partitioned into disjoint sets $Y,Z$, a $\phi$-ladder of length $n$ in a graph $G$ consists of two sequences of valuations $u_1,\ldots,u_n\in V(G)^Y$
    and $v_1,\ldots,v_n\in V(G)^Z$
     such that $G,u_i\oplus v_j\models \phi$ if and only if $i\le j$.
    
    
    
		Let $u,v\in V(G)^X$, $u_Y$ and $u_Z$ be the restrictions of $u$ to $Y$ and $Z$, respectively,
and $v_Y$ and $v_Z$ be the restrictions of $v$ to $Y$ and $Z$, respectively.
		We say that evaluations $u$ and $v$ are \emph{confusing} for $\phi$
		if $$G,u_Y\oplus v_Z\models \phi\iff G,v_Y\oplus u_Z\models \phi.$$
		



\medskip
The key technical lemma of this section is the following.

\begin{proposition}\label{pro:crossing}	
	Let $\phi$ be a formula with
 quantifier rank $q$ and
   free variables $X$
 partitioned as $X=Y\cup Z$. Further, let $G$ be a graph and $S\subset V(G)$ be a set of vertices.
Then one can associate to each tuple $v\in V(G)^X$
its \emph{$\phi$-type}, so that the following conditions 
hold:
	 \begin{enumerate}[(1)]
	 	\item\label{c:number} The  set of  $\phi$-types  of all tuples $v\in V(G)^X$  is finite and has size bounded by 
    $T(|S|,q)$, where $T\from \N\times \N\to \N$ is some computable function.
		
    % \item The $\phi$-type of $v\in V(G)^X$ only depends on the pair $(H,v)$, where $H$ is the subgraph induced by the vertices in $G$
    %     which are within distance at most  $r(q)$  from some vertex in the range of $v$, for some computable function $r(\cdot)$.

		
	 	\item\label{c:confusing}
  If $u,v\in V(G)^X$ are different, have the same $\phi$-types, and $\{u,v\}$ is mutually $2r(q)$-independent in $G-S$, then $u$ and $v$ are confusing for $\phi$, where
  $r\from \N \to \N$ is some computable function.
	 \end{enumerate}
\end{proposition}

Before proving~\cref{pro:crossing}, we show how it yields  \cref{thm:uqw-stable}. 

\begin{proof}[of \cref{thm:uqw-stable}]
Fix a formula $\phi$ of quantifier rank $q$ and with free variables $X$, partitioned into disjoint sets $Y,Z$.
For $d=|X|$,
let $N^d(\cdot,\cdot)$ and $s^d(\cdot)$ be functions yielded by \cref{prop:uqw-tuples}.
Let $T(\cdot,\cdot)$ and $r(\cdot)$ be the functions given by \cref{pro:crossing}.
We assume without loss of generality that the function $T(\cdot,\cdot)$ is weakly increasing in the first argument, by redefining $T(s,q)$ as $\max_{s'\le s} T(s,q)$.
Denote $r=r(q)$, $m=T(s^d(2r),q)+1$, and $\ell=N^d(2r,m)$.

We show that 
every $\phi$-ladder in a graph $G\in\cal C$ has length smaller than $\ell$. 
For the sake of contradiction, assume that there is a graph $G\in\cal C$, a number $k\ge \ell$,
and valuations $u_1,\ldots,u_k\in V(G)^Y$ and $ v_1,\ldots, v_k\in V(G)^Z$
which form a $\phi$-ladder in $G$.
Denote $w_i=u_i\oplus v_i$, for $i=1,\ldots,k$.
	Let $A=\set{ w_i\colon i=1,\ldots,k}\subset V(G)^X$; note that $|A|=k$.
Applying \cref{prop:uqw-tuples} to the set $A$, radius $2r$, and target size $m$
		 yields a set $S\subset V(G)$ with $|S|\le s^d(2r)$
	and a set $B\subset A$ with $|B|\geq m$ which is mutually $2r$-independent in $G-S$.
% Replacing $A$ by $B$, we may assume that $\bar u_1,\ldots,\bar u_m\in V(G)^{\bar u}$ and $\bar v_1,\ldots,\bar v_k\in V(G)^{\bar v}$
% form a $\phi$-ladder of length $m$ in $G$, and
% that $A$ is totally $2r$-independent in $G-S$.
%
%
% An \emph{$q$-local formula} $\phi(\bar x)$ is a
% formula such that for every colored graph $G$ and tuple of vertices $\bar a\in V(G)^{\bar x}$, the following equivalence holds:
% $$G,\bar a\models \phi\qquad\textit {if and only if }\qquad G[N^{r}(\bar a)],\bar a\models \phi.$$
%
% \begin{theorem}\label{thm:gaifman}
% 	Let $\phi(\bar x)$ be a formula over the signature of colored graphs of quantifier rank $q$.
% 	There is a  number $r\le 7^{q}$
% 	% , and $s\le q+|\bar x|$,
% 	such that $\phi$ is equivalent to a Boolean combination of sentences and $q$-local formulas $\psi^{(r)}(\bar x)$.% the following:
% % 	\begin{itemize}
% % 		\item $q$-local formulas ;
% % 		\item sentences.%  of the form $$\exists y_1,\ldots,y_s
% % % \bigwedge_{1\le i\le s} \alpha^{(r)}(y_i)\land
% % % \bigwedge_{1\le i<j\le s} d^{>2r}(y_i,y_j),$$
% % % where $\alpha^{(r)}(y)$ is $q$-local and in one variable,
% % %  and $d^{>2r}(v,w)$ expresses the property that $\set{v,w}$ is $2r$-independent.
% % 	\end{itemize}
% \end{theorem}
With each tuple $w_i\in B$ we associate its $\phi$-type, as described in~\cref{pro:crossing}.
Since $B$ has at least $m>T(|S|,q)$ elements, by
 the pigeonhole principle, there are $i$ and $j$ 
with $i<j$ such that $ w_i$ and $w_j$ have the same $\phi$-types. Since $\{w_i,w_j\}\subseteq B$ is mutually $2r$-independent in $G-S$, $w_i$ and $w_j$ are confusing for $\phi$, i.e., 
 $G,u_i\oplus v_j\models \phi$ 
 if and only if $G,u_j\oplus v_i\models \phi$. This contradicts the assumption that $u_1,\ldots, u_k$ and $ v_1,\ldots, v_k$ form a $\phi$-ladder, and finishes the proof of \cref{thm:uqw-stable}.
\end{proof}
It remains to prove~\cref{pro:crossing}. 
First we recall some notions from logic, namely quantifier ranks, Gaifman's Locality Theorem, and some simple manipulations on formulas.

 Fix a finite set of  colors $C$.
By a \emph{colored graph} we mean a graph  in which 
every vertex is assigned zero or more colors from $C$. We view a colored graph as a relational structure as usual, by treating each color as a unary predicate. 

The \emph{quantifier rank} of a formula $\phi$ is the maximal number of nested quantifiers in $\phi$.
For $i=1,2$, let $G_i$
be a colored graph and $v_i:X\to V(G_i)$ be a valuation
from a common set of variables $X$.
We say that $(G_1, v_1)$ and $(G_2,v_2)$
have the same \emph{quantifier rank $q$ type} %\marginpar{also called $q$-equivalent and denoted $(G_1,\bar v_1)\equiv_q (G_2, \bar v_2)$}
if for every formula $\phi$ with  free variables $X$ and of quantifier rank $q$,
 $$G_1,v_1\models \phi\qquad\iff \qquad G_2,v_2\models \phi.$$
If $G$ is a graph colored with colors from $C$ and 
 $v\from X\to V(G)$ is a valuation, 
then the equivalence class of $(G, v)$ under the above equivalence relation is called the \emph{quantifier rank $q$ type} of $(G,v)$, and  the set of \emph{quantifier rank $q$ types with  free variables $X$}
is the set of all equivalence classes, denoted
$\mathrm{Tp}^{q,C}_X$.

 If $G$ is a colored graph, $r\in\N$ is an integer, and $v$ is a valuation of a set of variables in $G$, then  $N^G_r[v]$ denotes the pair $(H,v)$, where $H$ is the colored subgraph of $G$
induced by the set of all vertices which are in distance at most $r$
from some vertex in the image of $v$.
If $r$ is an integer, then the \emph{$(r,q)$-local type} of $(G,v)$ is 
the quantifier rank $q$ type of $N^G_r[v]$. The $q$-\emph{local type} of $(G,v)$ is the $(r,q)$-local type, where $r$   is the value described in the second item of the following proposition,  summarizing several well-known properties of types and local types.


\begin{proposition}\label{pro:gaifman}
	Fix a positive integer $q$, a finite set of colors $C$, and a set of variables $X$. Let $G$ be any $C$-colored graph. Then the following conditions hold:
 \begin{enumerate}[(1)]
 	\item \emph{(Computability of types)} The set of types $\mathrm{Tp}^{q,C}_X$ is finite and computable from $C$, $X$, and $q$.

	\item \emph{(Locality of first order logic)} There is an integer $r$ computable from $q$ such that for every formula $\phi$ in the signature of $C$-colored graphs  
	of quantifier rank $q$ and with free variables $X$,	
  if $(G,v_1)$ and $(G,v_2)$ have the same $(r,q)$-local types,
	then
	 $$G_1,v_1\models \phi\qquad\iff \qquad G_2,v_2\models \phi.$$
   % We call $r$ the \emph{locality radius} for quantifier rank $q$, and fix this number in what follows.

%    \item \emph{(Monotonicity)} If $Y\subset X$ and $v \from X\to V(G)$
%    is a valuation, then the $(q,r)$-local type of $(G,v)$
% determines   the $(q,r)$-local type $(G,v|_Y)$ of the restriction of $v$ to $Y$.


	 \item \emph{(Independence)} Suppose $X$ is partitioned into $Y\cup Z$, 
	 and that $u_1,u_2\from Y\to V(G)$ and $v_1,v_2\from Z\to V(G)$ are valuations
   such that each of the sets $\{u_1,v_1\}$ and $\{u_2,v_2\}$
   is mutually $2r$-independent in $G$, for some $r$.
   Moreover, suppose that the $(r,q)$-local types of $(G,\im(u_1))$ and $(G,\im(u_2))$ are equal,
   and that the $(r,q)$-local types of $(G,\im(v_1))$ and $(G,\im(v_2))$ are equal.
   Then the $(r,q)$-local types of $(G,u_1\oplus v_1)$ and $(G,u_2\oplus v_2)$ are equal.
 \end{enumerate}
\end{proposition}


\begin{proof}%[of~\cref{pro:gaifman}]

\emph{Computability of types} is standard~(see e.g. Lemma 3.13 in~\cite{libkin}).
% and  yields the first condition in~\cref{pro:gaifman}.
% \begin{lemma}\label{lem:q-types}
%   Fix a set of colors $C$, a rank $q$ and a set of variables $X$.
%   Then the set $\mathrm{Tp}^{q,C}_X$ of quantifier rank $q$ types with free variables $X$ is finite and computable.
% \end{lemma}

\emph{Locality of first order logic} is an
immediate consequence of Gaifman's Locality Theorem
(the Main Theorem~in~\cite{gaifman1982local}),
where it is shown that one can take $r=7^q$.
It is also known (cf. Corollary 4.13 in \cite{libkin}) that it suffices to take $r=\frac{3^{q+1}-1}2$.


% We say that a formula $\phi(\bar x)$ with $d=|\bar x|$ free variables is \emph{$q$-local} if for every colored graph $G$ and every $\bar a_1,\bar a_2\in V(G^d)$, if  $N^G_r(\bar a_1)$ and  $N^G_r(\bar a_2)$
% are isomorphic, then $G,\bar a_1\models \phi(\bar x)$ if and only if $G,\bar a_2\models \phi(\bar x)$.
%
% \begin{lemma}\label{lem:gaifman}
%   Let $\phi$ be a  formula
%   of quantifier rank $q$
%   in the signature of colored graphs, with free variables $X$.
%   Suppose $v_1,v_2$ are valuations of $X$ in $G$ such that $N^G_r[v_1]$ and $N^G_r[v_2]$ have the same quantifier rank $q$ type, where $r=7^q$. Then
%  $$G,v_1\models \phi\qquad\iff \qquad G,v_2\models \phi.$$
% \end{lemma}

% We also use the following well-known fact about the compositionality of types
% under taking disjoint unions. The proof is a standard application of Ehrenfeucht-Fraisse games, so we only give a sketch.
For \emph{Independence}, write $G\oplus H$ for the disjoint union of colored graphs $G,H$. 
We use the following claim, whose proof is a standard application of Ehrenfeucht-Fraisse games.


		\begin{claim}\label{lem:type-union}
			For $i=1,2$, let $G_i,H_i$ be colored graphs,
			and $v_i\from Y\to V(G_i)$ and $w_i\from Z\to V(H_i)$ be valuations.
			Suppose that $(G_1,v_1)$ and $(G_2,v_2)$ 
			have the same quantifier rank $q$ type,
			and $(H_1,w_1)$ and $(H_2,w_2)$ 
			have the same quantifier rank $q$ type.
			Then the quantifier rank $q$ type of the disjoint union 
			$(G_1\oplus H_1,v_1\oplus w_1)$ is equal to the one of $(G_2\oplus H_2,v_2\oplus w_2)$. \end{claim}
\begin{clproof}[Sketch]
	The proof proceeds by applying the well-known characterization 
	of quantifier rank $q$  types using Ehrenfeucht-Fraisse games (see e.g. Theorem 3.9 in~\cite{libkin}). By assumption, duplicator has a winning strategy $\gamma$ in the $q$-round game on $(G_1,v_1)$ and $(G_2,v_2)$, and a winning strategy $\eta$ in the $q$-round game on $(H_1,w_1)$ and $(H_2,w_2)$. The strategies $\gamma$ and $\eta$ can be combined into a winning strategy on $(G_1\oplus H_1,v_1\oplus w_1)$  and $(G_2\oplus H_2,v_2\oplus w_2)$.
\end{clproof}
The \emph{Independence} property is now almost immediate. Since $\{u_1,v_1\}$ is mutually $2r$-independent in $G$, the subgraph of $G$ induced by the $r$-neighborhood of $\im(u_1\oplus v_1)$ is isomorphic to the disjoint union of the subgraphs of $G$ induced by the $r$-neigbhorhoods of $\im(u_1)$ and $\im(v_1)$. The same holds also for the $r$-neighborhoods of $\im(u_2\oplus v_2)$, 
$\im(u_2)$, and $\im(v_2)$. It now suffices to apply \cref{lem:type-union} and use the assumed equality of $(r,q)$-local types.
\end{proof}

We now prove \cref{pro:crossing}. Until the end of the proof, fix a graph $G$ and a set of vertices $S\subset V(G)$.
We now introduce some notation allowing to translate a  formula~$\phi$ talking about  $G$ into an equivalent formula $\phi'$ talking 
about a suitably colored  graph $G$ with the set of vertices $S$ removed.
Precisely, define the structure $G^{S}$
as the graph $G-S$ colored with colors $\set{C_s\colon s\in S}$ as follows.
For each $s\in S$, a vertex $v\in V(G)-S$
is colored with color $C_s$ in $G^S$ if and only if $v$ is a neighbor of $s$
in~$G$.

Fix a formula $\phi$ with free variables $X$.
If $G$ is a (colored) graph, $S\subset V(G)$ is a set of vertices, and $Y$ is a set of variables disjoint from $V(G)$, then 
a \emph{pre-valuation} in $Y\cup S$ is a 
function $\alpha\colon X\to Y\cup S$.
If $v\from Y\to V(G)$ is a valuation and $\alpha$ is as above,
then by $\alpha\cdot v$ we denote the valuation of $X$ in $V(G)$
which maps $x\in X$ to $\alpha(x) $ if $\alpha(x)\in S$
and to $v(\alpha(x))$ if $\alpha(x)\in Y$.
 The  pair $(\phi,\alpha)$  can be treated as a
syntactic object denoted  $\phi^{\alpha}$,
 whose semantics is defined so that for a valuation $v\from Y\to V(G)$, 
$$G,v\models \phi^{\alpha}\qquad\iff \qquad G,\alpha\cdot v\models \phi.$$
Intuitively $\phi^\alpha$ is the formula $\phi$ with variable $x$ substituted by $\alpha(x)$,
which can be either a variable in $Y$ or a vertex in $S$, treated as a constant.


\begin{lemma}\label{lem:remove-s}Let $G,S$ be as above.	
For every formula $\phi$ with free variables $X$ and every pre-valuation $\alpha\from X\to Y\cup S$
there is a formula $\phi'$ with free variables $Y$
of the same quantifier rank as $\phi$ and over the signature of $G^S$
 such that for every valuation $v$ of $Y$ in $G-S$, we have
$$G,v\models\phi^{\alpha}\qquad\iff\qquad G^S,v\models\phi'.$$
\end{lemma}
\begin{proof}
The proof proceeds by induction on the structure of the formula $\phi$. 

If $\phi$ is an atomic formula $E(x,x')$ or $x=x'$, then the formula $\phi'$ is constructed by case analysis. If $\alpha(x),\alpha(x')\in Y$ then $\phi'$
is obtained from $\phi$ by substituting the variables $x,x'$ with variables from $Y$ according to~$\alpha$. If  $\alpha(x),\alpha(x')\in S$ then $\phi'$ is the truth value $\bot$ or $\top$ of 
the formula $\phi$ in the graph $G$ under the valuation which maps $x$ to $\alpha(x)$ and $x'$ to $\alpha(x')$. Finally, suppose that $\alpha(x)=y\in Y$ and $\alpha(x')=s\in S$. If $\phi$ is $E(x,x')$ then $\phi'$ is the formula $C_{s}(y)$, and if $\phi$ is $x=x'$ then $\phi'$ is the formula $\bot$.
 
 

%
% then, depending on whether $\alpha(x),\alpha(x')$ belong to $Y$ or to $S$, we consider  the appropriate case in the list below, where $y,y'$ range over $Y$ and $s,t$ range over $S$:
% \begin{enumerate}
% 	$E(y,y')\mapsto E(y,y')$
%
% 	\item If $\alpha(x)=y$ and $\alpha(x')=y'$ then $\phi'$ is $E(y,y')$.
% 	\item If $\alpha(x)=y$ and $\alpha(x')=s$ then $\phi'$ is $C_s(y)$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=y'$ then $\phi'$ is $C_s(x')$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=t$ then $\phi'$ is $\top$ if $s$ and $t$ are adjacent in $G$ and $\bot$ otherwise.
% \end{enumerate}
% We proceed similarly when $\phi$ is an atomic formula $x=x'$:
% \begin{enumerate}
% 	\item If $\alpha(x)=y$ and $\alpha(x')=y'$ then $\phi'$ is $y=y'$.
% 	\item If $\alpha(x)=y$ and $\alpha(x')=s$ then $\phi'$ is $\bot$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=y'$ then $\phi'$ is $\bot$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=t$ then $\phi'$ is $\top$ if $s=t$ are adjacent in $G$ and $\bot$ otherwise.
% \end{enumerate}





For the inductive step, we consider two cases.
If $\phi$ is a boolean combination of formulas $\phi_1,\ldots,\phi_k$, then 
apply the inductive assumption to each formula $\phi_i$,
yielding formulas $\phi_1',\ldots,\phi_k'$. Then let $\phi'$ be the analogous boolean combination of the formulas $\phi_1',\ldots,\phi_k'$.

Finally, suppose that $\phi$ is of the form $\exists x.\psi$, where   $Y$ are the free variables of $\phi$ and $x\not \in Y$.
 For $w$ being either the variable $x$ 
or an element $s\in S$, 
let $\psi^w$ be the formula obtained from the inductive assumption applied to the formula $\psi$ 
and pre-valuation $\alpha$ extended to a valuation which maps  $x$ to $w$. 
Then let $\phi'$
be the formula $\exists x.\psi^x \lor \bigvee_{v\in S}\psi^v$.
The case of $\forall$ is dual.

In each case, it follows from the inductive assumption that $\phi'$ 
satisfies the required condition.
\end{proof}



Let $X$ be a set of variables.
For a valuation  $v$ of $X$ in $G$, we introduce the notion of an \emph{$S$-decomposition} of $v$,  
which is the (essentially unique) pair $(\alpha,v^S)$
such that $\alpha\from X\to Y\cup S$ is a pre-valuation
for some set of variables $Y$,
and $v^S\from Y\to (\im(v)-S)$ is a bijective valuation such that 
$\alpha\cdot v^S=v$. The formal definition is as follows.
% Let $\sim$ be the partial equivalence on $X$ defined so that
% $x\sim x'$ if and only if both $x$ and $x'$ are mapped to the same element of $Y$.
% In other words, $\sim$ is the restriction of the kernel of $v$ to $v^{-1}(Y)$.
Let $Y=\set{v^{-1}(\set u)\colon u\in \im(v)-S}$. We treat $Y$ as a set of variables. 
% Note that $Y$ is in bijection with $\rg(v)-S$, but we prefer
% to define $Y$ in a way which is independent of the elements of $G-S$ for technical reasons.
Define the pre-valuation $\alpha\from X\to Y\cup S$
by letting $\alpha(x)$ be $v(x)$ if $v(x)\in S$,
and $v^{-1}(\set u)$ if $v(x)=u$ for some $u\in \im(v)-S$.
Finally, let $v^S$ be the valuation of $Y$ in $G$ which
maps  $v^{-1}(\set u)$ to $u$, for $u\in \im(v)-S$.
It is easy to see that $v=\alpha\cdot v^S$ and $v^S$ is a bijection from $Y$ 
to $\im(v)-S$. We call the pair $(\alpha,v^S)$ the \emph{$S$-decomposition of $v$}.



For a number $q$ and valuation $v\from X \to V(G)$, the \emph{$(q,S)$-local type} of $v$ 
is the pair $(\alpha,\tau)$,
where $(\alpha,v^S)$ is the $S$-decomposition of~$v$
and $\tau$ is the $q$-local type of   $(G^S,v^S)$.
Note that there are at most  $(s+d)^d$ possible functions $\alpha$, where $s=|S|$ and $d=|X|$. In particular, by the computability of types (cf.~\cref{pro:gaifman}), 
the number of $(q,S)$-local types of valuations from $X$
in arbitrary graphs is bounded by 
a number computable from $s,d$, and $q$.




\begin{lemma}\label{lem:coloring}
	Let $\phi$ be a formula with
free variables $X$ and of quantifier rank $q$.
	Suppose that $u$~and~$v$ are two valuations of $X$  in $G$ with the same $(q,S)$-local types.
	Then $$G,u\models \phi\qquad \iff\qquad G,v\models \phi.$$
\end{lemma}
\begin{proof}
Let $(\alpha,\tau)$ be the $(q,S)$-local type of the valuations $u$ and $v$, where $\alpha\from X\to Y\cup S$ for some set of variables $Y$. Let $(\alpha,u^S)$ be the $S$-decomposition of $u$
and let $(\alpha,v^S)$ be the $S$-decomposition of $v$.
	Consider the formulas $\phi^{\alpha}$ and $\phi'$ as described in \cref{lem:remove-s}, both with free variables $Y$.
	In particular, the following equivalences hold:
	\begin{align*}
	G,u\models\phi\iff G,u^S\models\phi^{\alpha}\iff G^S,u^S\models\phi',\\
	G,v\models\phi\iff G,v^S\models\phi^{\alpha}\iff G^S,v^S\models\phi'.
	\end{align*}
		Note that $\phi'$ has the same quantifier rank as  $\phi$, that is, $q$.
		Since $u$ and $ v$ have the same $(q,S)$-local type $\tau$, it follows that $(G^S,u^S)$ and $(G^S,v^S)$ have the same   $q$-local type.
		By the locality of first order logic (cf.~\cref{pro:gaifman}) applied to $G^S$, $\phi'$, $ u^S$, and $v^S$, we infer that $G^S,u^S\models\phi'$ if and only if $G^S,v^S\models\phi'$.
		The lemma follows by combining this with the above equivalences.
\end{proof}

% For a graph $G$, a set of vertices $S\subset V(G)$, a set of variables $X$, and  valuations $u,v$ of $X$ in $G$, we say that $u,v$ are mutually $2r$-independent in $G-S$
% if, when treating $u$ and $v$ as  tuples of length $|X|$,
% the set  $\set{u,v}$ is mutually $2r$-independent in $G-S$.


% \begin{lemma}\label{lem:crossing}	Let $\phi$ be a formula with
% 	 whose set of free variables $X$ is partitioned into  disjoint sets $Y,Z$.
% Let $u$ and $v$ be valuations of $X$ in $G-S$ which, treated as tuples,
% are mutually $2r$-independent in $G-S$, i.e.,  $u(x)$ and $v(x')$ are at distance larger than $2r$ in the subgraph of $G$ induced by $V(G)-S$,
% for $x,x'\in X$.
% Let $u_Y$ and $u_Z$ be the restrictions of $u$ to $Y$ and $Z$ respectively,
% and let $v_Y$ and $v_Z$ be the restrictions of $v$ to $Y$ and $Z$ respectively.
%   Suppose that $u_Y$ and $v_Y$ have the same $q$-local type, and that $u_Z$ and $v_Z$ have the same $q$-local type. Then
%   the valuations $u_Y\oplus v_Z$ and $v_Y\oplus v_Z$
%   of $X$ in $G-S$
%   have the same $q$-local types. In particular,
% $$G,u_Y\oplus v_Z\models \phi\iff G,v_Y\oplus v_Z\models \phi.$$
% \end{lemma}
We are now ready to prove~\cref{pro:crossing}.
\begin{proof}[of~\cref{pro:crossing}]
Let $\phi$ be a formula
	of  quantifier rank $q$
   whose free variables $X$ are partitioned into $Y$ and $Z$.
  Let $C$ be the set of colors $\set{C_s:s\in S}$.
  Let $r$ be the number given by the locality of first order logic (cf.~\cref{pro:gaifman}).
  

	For a valuation $v\in V(G)^X$, define the \emph{$\phi$-type} of $v$
  as the ordered pair consisting of two $(q,S)$-local types: of $v|_Y$  and of $v|_Z$. 
 It is clear that condition~\eqref{c:number} of~\cref{pro:crossing} is satisfied. We are left with verifying condition~\eqref{c:confusing}.
	
Let $u,v\in V(G)^X$ be such that $\{u,v\}$ is mutually $2r$-independent in $G-S$,
and moreover $u$ and $v$ have the same $\phi$-type. We show that $u,v$
are confusing for $\phi$. 
Let $u_Y,u_Z$ and $v_Y,v_Z$ denote the restrictions of $u$ and $v$ to $Y$ and $Z$, respectively. 

\begin{claim}\label{cl:sametype}
Valuations $u_Y\oplus v_Z$ and $v_Y\oplus u_Z$ have the same 
$(q,S)$-local types.  
\end{claim}
\begin{clproof}
Let $(\alpha_Y,u_Y^S),(\alpha_Z,u_Z^S),(\beta_Y,v_Y^S),(\beta_Z,v_Z^S)$ denote the $S$-decompositions of  $u_Y,u_Z,v_Y,v_Z$, respectively. 
From the assumption that $u,v$ are mutually $2r$-independent in $G-S$ it follows in particular that
 $\im(u_Y)\cap\im(v_Z)\subset S$
and  $\im(v_Y)\cap \im(v_Z)\subset S$.
This implies that the $S$-decompositions of $u_Y\oplus v_Z$
and of  $v_Y\oplus u_Z$ can be computed in a componentwise fashion, and are as follows:
\begin{align}
u_Y\oplus v_Z &\colon \quad (\alpha_Y\oplus \beta_Z,  u_Y^S\oplus v_Z^S)\label{eq:dec1},\\  
v_Y\oplus u_Z &\colon \quad (\beta_Y\oplus \alpha_Z, v_Y^S\oplus u_Z^S)\label{eq:dec2}.
\end{align}
The assumption that $u,v$ have the same $\phi$-type implies the following:
\begin{itemize}
  \item  $\alpha_Y=\beta_Y$ and $\alpha_Z=\beta_Z$.
  In particular, the $S$-decompositions
  \eqref{eq:dec1} and \eqref{eq:dec2}  have the first components equal.
  
    \item Valuations $u_Y^S$ and  $v_Y^S$ have 
  the same $q$-local types, and similarly,
  $v_Z^S$ and  $u_Z^S$ have the same $q$-local types.
  Since $\{u,v\}$ is mutually $2r$-independent in $G-S$, it follows that both $\{u_Y^S,v_Z^S\}$ and $\{v_Y^S,u_Z^S\}$ are mutually $2r$-independent in $G^S$.
  By the independence property of~\cref{pro:gaifman}, the second components of the $S$-decompositions~\eqref{eq:dec1} and~\eqref{eq:dec2}
  have the same $q$-local type. 
\end{itemize}
The two observations above yield the conclusion of the claim.
\end{clproof}
By \cref{cl:sametype} and \cref{lem:coloring} we infer that $u$ and $v$ are confusing for $\varphi$. This finishes the proof.
\end{proof}



We conclude by proving \cref{thm:new-stable}, promised in \cref{sec:intro}, which follows by tracking the precise dependencies on the parameters in the proof of \cref{thm:uqw-stable}.

\begin{proof}[of \cref{thm:new-stable}]
  Let $r(\cdot)$ be the function described in~\cref{pro:crossing}. We 
  define the function $g(\cdot)$ from the statement of the theorem by $g(q)=10\cdot r(q)$.
	Let $\phi$ be the given formula of quantifier rank $q$ and with  free variables $X$, partitioned into $Y$ and $Z$.
  Denote $r=r(q)$. From now on we consider only graphs $G$ such that $K_t\not\minor_{10r} G$.

We first examine \cref{prop:uqw-tuples}, and in particular the dependence of the yielded functions 
$N^d(\cdot,\cdot)$ and $s^d(\cdot)$ on the assumed quasi-wideness properties of the class $\CCC$.
Precisely, having assumed that the underlying class $\CCC$ is quasi-wide with functions $N(\cdot,\cdot)$ and $s(\cdot)$,
we have~obtained:
$$
N^d(2r,m)=K(4r,m(d^2+1))\qquad\textrm{and}\qquad s^d(2r)=d\cdot s(4r),
$$
where $K(4r,m')$ is the $d$-fold composition of the function $f(m')=N(4r,m')\cdot m'$.
Thus, when establishing the values of $N^d(2r,m)$ and $s^d(2r)$, we refer to the quasi-wideness of $\CCC$ only by using numbers $s(4r)$ and $N(4r,m')$ for $m'\in \N$.
By \cref{thm:new-uqw}, it suffices to assume that $K_t\not\minor_{10r} G$ to have $s(4r)\leq t$ and $N(4r,m')\leq c(r,t)\cdot (m')^{(2t+1)^{8rt}}$ for some computable function $c(r,t)$.
Hence, this supposition alone, instead of full quasi-wideness of $\CCC$, is sufficient to claim that the conclusion of \cref{thm:new-uqw} holds with
$s^d(2r)$ bounded by a computable function of $t$, $d$, and $q$, and $N^d(2r,m)$ bounded by a computable function of $m$, $t$, $d$, and $q$.

	% In the proof of \cref{thm:uqw-stable} we have introduced the following parameters:
%   \begin{eqnarray*}
%   s=s^d(2r), \qquad T_i\le (s+d_i)^{d_i}\cdot |\mathrm{Tp}_{d_i}^{q,s}|\ \textrm{ for $i=1,2$},\qquad\textrm{and}\qquad m=T_1T_2+1.
%   \end{eqnarray*}
%   As we argued, $s$ is bounded by a computable function of $t$, $d$, and $q$.
%   It is well known that given $d_1,d_2,q,s$, one can compute the number of quantifier rank $q$ types $|\mathrm{Tp}_{d_1}^{q,s}|$ and $|\mathrm{Tp}_{d_2}^{q,s}|$; see e.g.~\cite{libkin}.
%   Thus, $m$ is also bounded by a computable function of $t$, $d$, and $q$.
	
Finally, in the proof of \cref{thm:uqw-stable} we have argued that the ladder index of $\phi$ is bounded by $N^d(2r,m)$, where $d=|X|$, $m=T(s^d(2r),q)+1$
and $T(\cdot,\cdot)$ is a computable function,
and the only reference to the quasi-wideness of $\CCC$ in the proof
is by invoking \cref{prop:uqw-tuples}.
As we argued above, in \cref{prop:uqw-tuples} it suffices to assume $K_t\not\minor_{10r} G$ to claim that $N^d(2r,m)$ is bounded by a computable function of $m$, $t$, $d$, and~$q$.
Since $m$ is bounded by a computable function of $t$, $d$, and $q$, the obtained upper bound on the ladder index of $\varphi$ depends in a computable way on $t$, $d$, and~$q$,
and to derive it we only need to assume that $K_t\not\minor_{10r} G$. This concludes the proof.
\end{proof}

\begin{comment}
$N(\cdot,\cdot)$ be the function given by \cref{thm:new-uqw}.
	Following the proof of \cref{prop:uqw-tuples}, we see that for the functions $N^d(r,m)$ and $s^d(r)$, we can take the following functions:%
		\newcommand{\pow}{\ \uparrow\ }%
	\begin{align*}
	 N^d(r,m)&= c\cdot (m d)\pow(2(t+4))\pow(d(t+2r)),\\
	  s^d(r)&= d\cdot t,
	\end{align*}
where $x\pow y$ denotes $x^y$ and associates to the right, i.e., $x\pow y\pow z=x^(y^z)$.
In particular, the proof of \cref{prop:uqw-tuples} shows the following property
($\ast$)
for every graph $G$ such that $K_t\not\minor_{3r+1} G$ 
and for every set of $d$-tuples $A\subset V(G)^d$ of size at least $N^d(r,m)$
there is a subset $B\subset A$ of size $m$ and $S\subset V(G)$ of size at most $s^d(r)$
such that $B$ is mutually $r$-independent in $G-S$.

	
As in the proof of \cref{thm:uqw-stable}, let $r=7^q$,  
$s=s^d(2r)=d\cdot t$,  $T=(s+d)^d\cdot |\mathrm{Tp}_d^{q,s}|$ and $m=T+1$.



Let $\cal C$ be the class of all graphs $G$
such that $K_t\not\minor_{3r+1} G$, i.e., $K_t\not\minor_{3\cdot 7^q+1} G$. We repeat the argument presented in the second paragraph of the proof of \cref{thm:uqw-stable}, and assume that there is a $\phi$-ladder in $G\in \cal C$ of length larger than $N^d(2r,m)$.
 Instead of applying \cref{prop:uqw-tuples} we apply  ($\ast$) above
and obtain sets  $S$ and $B$ with the required properties. As before, this yields a contradiction. 


In particular, every $\phi$-ladder in a graph $G\in \cal C$ has length at most $N^d(2r,m)$, 
which is at most $$c'\cdot (d^{d+1}\cdot (t+1)^d\cdot |\mathrm{Tp}_d^{q,d\cdot t}|)\pow(2t+8)\pow(d\cdot t+2d\cdot 7^q),$$
where $c'$ is some constant.
As the number $|\mathrm{Tp}_d^{q,s}|$ is computable given $d,q,s$, this 
 yields \cref{thm:new-stable}.
\end{proof}
\end{comment}
