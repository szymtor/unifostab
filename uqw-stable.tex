
\section{From uniform quasi-wideness to stability}\label{sec:stable}

In this section we focus on proving the following result, observed earlier by Adler and Adler~\cite{adler2014interpreting}.

\begin{theorem}\label{thm:uqw-stable}
	Let $\cal C$ be a uniformly quasi-wide class of graphs.
	Then $\cal C$ is stable. % More precisely, if $\phi(\bar u,\bar v)$ is a formula with $d$ free variables and quantifier rank $q$, and $N^d(r,m)$ and $s^d(r)$ are as in Proposition~\ref{prop:uqw-tuples}, then for all graphs $G\in\cal C$,  the ladder index of $\phi$ is at most $N^d(2r,(2T)^d)$,
% where $r= 7^q$,
%  $T$ is the number of all quantifier rank $q$ types with one free  variable over the signature of  graphs colored with $s^d(2r)$ colors.
%\marginpar{shall we recall the definition of stability and ladders?}
\end{theorem}

Recall that a class $\cal C$ is stable if and only if for every first-order formula $\varphi(\bar x,\bar y)$, its ladder index over graphs from $\cal C$ is bounded by a constant depending only on $\cal C$ and $\varphi$;
see \cref{sec:intro} to recall the background on stability.
Thus \cref{thm:uqw-stable} is implied by \cref{thm:new-stable} (stated in \cref{sec:intro}), and is weaker in the following sense: \cref{thm:new-stable} asserts in addition that there is a computable bounds on the ladder index
of any formula that depends only on the size of an excluded clique minor on a levels bounded in terms of formula's quantifier rank and number of free variables. At the end of the proof we argue that
the obtained bounds in fact also imply the stronger statement of \cref{thm:new-stable}, but for the clarity of presentation we find it more instructive to work with the cleaner formulation of \cref{thm:uqw-stable}.

The plan is as follows. In \cref{sec:uqw-tuples} we formulate a variant of uniform quasi-wideness tailored to tuples of vertices. Using this and Gaifman's Locality Theorem, we prove \cref{thm:uqw-stable} in \cref{sec:uqw-stable}.


\subsection{Uniform quasi-widness for tuples}\label{sec:uqw-tuples}
Fix a graph $G$, the dimension $d\in\N$, and the radius $r\in \N$.
If $S\subset V(G)$ is a set of vertices and $A\subset V(G)^d$ is a set of $d$-tuples of vertices,
then we say that $A$ is \emph{mutually $r$-independent} in $G-S$ 
if for every two distinct $(u_1,\ldots,u_d),(v_1,\ldots,v_d)\in A$
and for all $1\le i,j\le d$, the distance between the vertices $u_i$ and $v_j$ in the graph $G-S$
is larger than $r$. Throughout this section we use the convention that if $x\in S$, then the distance in $G-S$ between $x$ and any vertex, including~$x$ itself, is infinity. 
For instance, in the definition above, the tuples from $A$ may contain vertices of~$S$, and such a vertex is considered infinitely far from every vertex.

We now prove the following proposition, which can be viewed as an extension of uniform quasi-wideness to tuples.
The proof is based on translating the approach of Podewski and Ziegler~\cite{podewski1978stable} to the finite.

\begin{proposition}\label{prop:uqw-tuples}
	Let $\cal C$ be a uniformly quasi-wide class of graphs and $d\in\N$ be an integer.
	Then there are functions $N^d\colon \N\times\N\to\N$ and $s^d\colon \N\to\N$
	such that for all $r,m\in\N$ and all subsets $A\subset V(G)^d$
	with $|A|\ge N^d(r,m)$ there  is a set $S\subset V(G)$
	of size $|S|\le s^d(r)$ and a subset $B\subset A$ of size $|B|\ge m$ which is mutually $r$-independent in $G-S$.
\end{proposition}

The rest of this section is devoted to the proof of \cref{prop:uqw-tuples}.
Fix a uniformly quasi-wide class $\cal C$ and functions $N:\N\times\N\to \N$
	and $s:\N\to\N$ as in the definition of uniform quasi-wideness.
	Let $d\in \N$ be a fixed dimension.
		For a fixed graph $G\in \cal C$  and
	  coordinate $i\in\set{1,\ldots,d}$, let $\pi_i$ denote the projection from $V(G)^d$ onto the $i$th coordinate.

	


\begin{lemma}\label{lem:step1} For any $r,m\in \N$ there is an integer $K(r,m)$ such that
	for any given $A\subset V(G)^d$ with $|A|\ge K(r,m)$,
	there is a set $B\subset A$ with $|B|\ge m$ and a set $S\subset V(G)$ with $|S|\le d\cdot s(r)$, 
	such that for each coordinate $i\in\set{1,\ldots,d}$ and all distinct $\bar x,\bar y\in B$,
 $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at distance greater than $r$ in $G-S$. 
\end{lemma}
\begin{proof}
We will iteratively apply the following claim.

%Let $f\colon \N\to \N$ be defined as $f(m)=N(r,m)\cdot m$ for $m\in\N$.

\begin{claim}\label{claim:ith-coord}
Fix a coordinate $i\in\set{1,\ldots,d}$, an integer $m'\in\N$, and a  set $A'\subset V(G)^d$ with  $|A'|\ge N(r,m')\cdot m'$.
Then there is a set $B'\subset D$ with $|B'|\ge m'$
and a set $S'\subset V(G)$ with $|S'|\le  s(r)$, such that for all distinct $\bar x,\bar y\in B$,
 $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at distance greater than $r$ in $G-S$. 
\end{claim}
\begin{clproof}
We consider two cases.

If $\pi_i(A')\subset V(G)$ has at least $N(r,m')$ elements, then we apply the definition of uniform quasi-wideness to $\pi_i(A')\subset V(G)$. This yields sets $S'\subset V(G)$ and $B''\subset \pi_i(A')$
such that $|B''|\ge m'$, $|S'|\le s(r)$, and $B''$ is $r$-independent in $G-S'$. 
Let $B'\subseteq A'$ be a subset of tuples constructed as follows: for each $u\in B''$, include in $B'$ one arbitrarily chosen tuple $\bar x\in A'$ such that $\pi_i(\bar x)=u$.
Clearly $|B'|=|B''|\ge m'$ and for all distinct $\bar x,\bar y\in B'$, we have that $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are distinct and at distance greater than $r$ in $G-S$; this is because $B''$ is $r$-independent
in $G-S$. Hence $B'$ and $S'$ satisfy all the required properties.

If $\pi_i(A')$ has less than $N(r,m')$ elements, then choose the element $a\in\pi_i(A')$ whose inverse image $\pi_i^{-1}(\set a)\cap A'$ has the largest cardinality. Let $S'=\set{a}$ 
and let $B'=\pi_i^{-1}(\set a)$. Then $$|B'|\ge \frac{|A'|}{|\pi_i(A')|}\ge \frac{|A'|}{N(r,m')}\ge \frac {N(r,m')\cdot m'}{N(r,m')}=m',$$
and $|S'|=1$. Observe that $\pi_i(\bar x)=a$ for all $\bar x\in A'$. As $a\in S$, by the adopted convention we have that $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at infinite distance for all distinct $\bar x,\bar y\in B$.
\end{clproof}

We proceed with the proof of \cref{lem:step1}.
Let $f(m')=N(r,m')\cdot m'$ for $m'\in\N$; by $f^k$ we denote the $k$-fold composition of $f$ with itself.
Let $A\subset V(G)^d$ be such that $|A|\ge f^d(m)$. 
Define $B_0=A$, $S_0=\emptyset$, and for $i=1,\ldots,d$,
let $B_{i}$ and $S_i$ be the $B'$ and $S'$ obtained from \cref{claim:ith-coord} applied to the set of tuples $B_{i-1}\subset V(G)^d$, the coordinate $i$, and $m'=f^{d-i}(m)$. 
The invariant is that $|B_i|\ge f^{d-i}(m)$.
In particular, 
taking $B=B_d$ and $S=S_1\cup\ldots \cup S_d$, we obtain that $|B|\ge m$ and $|S|\le d\cdot s(r)$, and, by construction, $\pi_i(B)$
is $r$-independent in $G-S$ for every coordinate $i\in\set{1,\ldots,d}$. Letting $K(r,m)=f^d(m)$ yields the lemma.
\end{proof}


\begin{lemma}\label{lem:step2}
	Let $B\subset V(G)^d$ and $S\subset V(G)$ be such that \begin{itemize}
	\item for all $i\in \set{1,\ldots,d}$,
	$\pi_i(B)$ is $2r$-independent in $G-S$, and 
	\item for each tuple $\bar a\in B$, the set of entries of $\bar a$ is $r$-independent in $G-S$.  
	\end{itemize}
	Then there is a set $C$ with $C\subset B$ 
	such that $C$ is mutually $r$-independent in $G-S$
	and $|C|\geq\frac{|B|}{d^2+1}$.
\end{lemma}
\begin{proof}
We construct a sequence $C_0\subset C_1\subset \ldots$ of subsets of $B$ which are mutually $r$-independent in $G-S$, as follows.

We start with $C_0=\emptyset$. Suppose that $C_s\subset B$ is 
 already constructed for some $s\ge 0$
 and is mutually $r$-independent in $G-S$; we construct $C_{s+1}$. With each element $a\in B-C_s$,
we associate an arbitrarily chosen function $f_a\colon \set{1,\ldots,d}^2\to C_s\cup \set{\bot}$
with the following properties:
\begin{itemize}
	\item If $f_a(i,j)=b$ then the $i$th coordinate of $a$
	and the $j$th coordinate of $b$ are at distance at most $r$
	in $G-S$.
	\item If $f_a(i,j)=\bot$ then there is no element $b\in C_s$ 
	such that the $i$th coordinate of $a$ and the $j$th coordinate of $b$ are at distance at most $r$ in $G-S$.	
\end{itemize}
Observe that whenever $a_1, a_2$ are two distinct elements of $B-C_s$,
then for all $i,j\in \set{1,\ldots,d}^2$, the values $f_{a_1}(i,j)$ and $f_{a_2}(i,j)$
cannot be equal to the same element $b\in C_s$:
otherwise, we would have that the $i$th coordinate of $a_1$
and the $i$th coordinate of $a_2$ are at distance at most $2r$
in $G-S$, which is impossible by the assumption on $B$.
In particular, if $|B-C_s|> |C_s|\cdot d^2$
then there must be some element  $a\in B-C_s$  
such that $f_a(i,j)=\bot$  for all $i,j\in\set{1,\ldots,d}$.
Let $C_{s+1}=C_s\cup \set s$.
By construction, $C_{s+1}$ is mutually $r$-independent in $G-S$.

We may repeat the construction as long as $|B|>|C_s|\cdot (d^2+1)=s\cdot (d^2+1)$, and we stop when this inequality no longer holds. Define the set $C$ as the last constructed set $C_s$.
By construction, $|C_s|=s\ge 
\frac{|B|}{d^2+1}$.	
\end{proof}

To finish the proof of \cref{prop:uqw-tuples},
given a set $A\subset V(G)^d$ and integers $r,m\in\N$,
first apply 
\cref{lem:step1} 
  with $r'=2r$ and
 $m'= m\cdot (d^2+1)$.
 Assuming that $|A|\ge K(r',m')$, 
we obtain a set $B\subset A$ with $|B|\ge m\cdot (d^2+1)$ and a set $S\subset V(G)$ with $|S|\le s(2r)$.
Apply \cref{lem:step2} to $B$ and $S$, yielding a set $C\subset B$ which is mutually $r$-independent in $G-S$ and has size at least $m$. This concludes the proof of \cref{prop:uqw-tuples},
where the obtained bounds are $N^d(r,m)=K(r',m')=K(2r,m\cdot (d^2+1))$ and $s^d(r)=d\cdot s(2r)$.


\subsection{Excluding long ladders}
\label{sec:uqw-stable}


\newcommand{\rg}{\mathrm{rg}}
\newcommand{\fv}{\mathrm{fv}}
\newcommand{\from}{\colon}
We consider only finite sets of variables, and any mathematical object can be considered a variable (formally, whenever we want to treat an object $a$ as a variable, we  introduce a variable $x_a$, where $x$ is a fixed special symbol).
If $\phi$ is a formula then it has a specified set of free variables.
By abuse of language, if $X$ is a set of variables and $\phi$
is a formula, when we say that $\phi$ \emph{has free variables} $X$
we allow the set of free variables of $\phi$ to be a subset of $X$.

If $\phi$ is a formula with free variables $X$, $G$
is a  graph, then an $X$ tuple $v\in V(G)^X$ is sometimes called a \emph{valuation} of $X$ in $G$.
For a formula $\phi$ with free variables $X$ and $v\in V(G)^X$, we write $G,v\models \phi$ to denote that $\phi$ is satisfied 
in the graph $G$ with valuation $v$, which is defined as usual in logic, by induction on the structure of $\phi$.

For two tuples
$v\in V^Y$ and $w\in  W^Z$, where $Y$ and $Z$ are disjoint, by
$v\oplus w$ we denote the set-theoretic union of the functions $v,w$,
which is a tuple $v\oplus w\in (V\cup W)^{Y\cup Z}$.

	 	Fix a formula $\phi$ with free variables $X$, together with a distinguished partition $X=Y\cup Z$ into disjoint sets $Y,Z$.
		Let $G$ be a graph.
		Let $u,v\in V(G)^X$ 
		and let $u_Y$ and $u_Z$ be the restrictions of $u$ to $Y$ and $Z$, respectively,
and $v_Y$ and $v_Z$ be the restrictions of $v$ to $Y$ and $Z$, respectively.
		We say that $u,v$ are \emph{confusing} for $\phi$
		if $$G,u_Y\oplus v_Z\models \phi\iff G,v_Y\oplus v_Z\models \phi,$$
		



\medskip
The key technical lemma of~\cref{sec:uqw-stable} is the following.

\begin{proposition}\label{pro:crossing}	
	Let $\phi$ be a formula with free variables $X$ partitioned as $X=Y\cup Z$.
	 For every graph $G$ and set of its vertices $S\subset V(G)$ 
	 there is a set of colors $C$ and a coloring $c\from V(G)^X\to C$
 with the following properties:
	 \begin{itemize}		 
	 	\item The set of all colors $C$ can be computed from $|S|$ and from the quantifier rank of $\phi$, and does not depend on~$G$.
		
		\item The color $c(v)$ assigned to $v$ only depends on the radius $r$-neighborhood of $v$ in $G$, for some $r$ which depends only on $\phi$ and $|S|$.
		
		
	 	\item 
  If $u,v\in V(G)^X$ have the same colors and are mutually $2r$-independent in $G-S$, then they are confusing for $\phi$.
	 \end{itemize}
\end{proposition}

Before proving~\cref{pro:crossing}, we show how it yields  \cref{thm:uqw-stable}. 

\begin{proof}[of \cref{thm:uqw-stable}]
Fix a formula $\phi$ with free variables $X$, partitioned into disjoint sets $Y,Z$.
Let $N^d(\cdot,\cdot)$ and $s^d(\cdot)$ be functions yielded by \cref{prop:uqw-tuples}.
Let $C$ be the be the set of colors as described in Proposition~\ref{pro:crossing}, for sets $S$ of size $s^d(2r)$,
and let $m=|C|+1$.

We show that 
every $\phi$-ladder in a graph $G\in\cal C$ has length smaller than $N^d(2r,m)$. 
For the sake of contradiction, assume that there is a graph $G\in\cal C$, a number $k\ge N^d(2r,m)$,
and valuations $u_1,\ldots,u_k\in V(G)^Y$ and $ v_1,\ldots, v_k\in V(G)^Z$
which form a $\phi$-ladder in $G$.
Denote $w_i=u_i\oplus v_i$, for $i=1,\ldots,k$.
	Let $A=\set{ w_i\colon i=1,\ldots,k}\subset V(G)^X$; note that $|A|=k$.
Applying \cref{prop:uqw-tuples} to the set $A$, radius $2r$, and target size $m$
		 yields a set $S\subset V(G)$ with $|S|\le s^d(2r)$
	and a set $B\subset A$ with $|B|\geq m$ which is mutually $2r$-independent in $G-S$.
% Replacing $A$ by $B$, we may assume that $\bar u_1,\ldots,\bar u_m\in V(G)^{\bar u}$ and $\bar v_1,\ldots,\bar v_k\in V(G)^{\bar v}$
% form a $\phi$-ladder of length $m$ in $G$, and
% that $A$ is totally $2r$-independent in $G-S$.
%
%
% An \emph{$q$-local formula} $\phi(\bar x)$ is a
% formula such that for every colored graph $G$ and tuple of vertices $\bar a\in V(G)^{\bar x}$, the following equivalence holds:
% $$G,\bar a\models \phi\qquad\textit {if and only if }\qquad G[N^{r}(\bar a)],\bar a\models \phi.$$
%
% \begin{theorem}\label{thm:gaifman}
% 	Let $\phi(\bar x)$ be a formula over the signature of colored graphs of quantifier rank $q$.
% 	There is a  number $r\le 7^{q}$
% 	% , and $s\le q+|\bar x|$,
% 	such that $\phi$ is equivalent to a Boolean combination of sentences and $q$-local formulas $\psi^{(r)}(\bar x)$.% the following:
% % 	\begin{itemize}
% % 		\item $q$-local formulas ;
% % 		\item sentences.%  of the form $$\exists y_1,\ldots,y_s
% % % \bigwedge_{1\le i\le s} \alpha^{(r)}(y_i)\land
% % % \bigwedge_{1\le i<j\le s} d^{>2r}(y_i,y_j),$$
% % % where $\alpha^{(r)}(y)$ is $q$-local and in one variable,
% % %  and $d^{>2r}(v,w)$ expresses the property that $\set{v,w}$ is $2r$-independent.
% % 	\end{itemize}
% \end{theorem}
With each tuple $w_i\in B$ we associate the color as described in~\cref{pro:crossing}.
The number of such different pairs is $|C|$, and since $B$ has at least $m>|C|$ elements, by
 the pigeonhole principle, there are $i$ and $j$ 
with $i<j$, such that $ w_i$ and $w_j$ have the same colors. Since $w_i$ and $w_j$ are $2r$-independent in $G-S$, they are confusing for $\phi$, i.e., 
 $G,u_i\oplus v_j\models \phi$ 
 if and only if $G,u_j\oplus v_i\models \phi$, which contradicts the assumption that $u_1,\ldots, u_m$ and $ v_1,\ldots, v_m$ form a $\phi$-ladder.
 This finishes the proof of \cref{thm:uqw-stable}.
\end{proof}
It remains to prove~\cref{pro:crossing}. 
First we recall some notions from logic, namely quantifier ranks, Gaifman's Locality Theorem, and some simple manipulations on formulas.


By a \emph{colored graph} we mean a graph  in which 
every vertex is assigned zero or more colors from a fixed set of colors. We view a colored graph as a relational structure as usual, by treating each color as a unary predicate. 
The \emph{quantifier rank} of a formula $\phi$ is the maximal number of nested quantifiers in $\phi$.

\begin{proposition}\label{pro:gaifman}
	Let $q$ be a positive integer, let $C$ be a finite set of colors and let $X$ be a set of variables. There is a set of \emph{types} $\mathrm{Tp}^{q,C}_X$
	and an assignment which maps every pair $(G,v)$ consisting of a $C$-colored graph $G$ and tuple $v\in V(G)^X$, to its \emph{quantifier rank $q$ type} in $\mathrm{Tp}^{q,C}_X$,
 with the following properties:
 \begin{itemize}
 	\item \emph{(Computability of types)} The set of types $\mathrm{Tp}^{q,C}_X$ is finite and computable from $q, s$, and $X$,
	\item \emph{(Locality)} The quantifier rank $q$ type of a pair $(G,v)$ depends only on 
	the pair $(H,v)$, where $H$ is the colored subgraph induced by the set of all vertices in $G$ which are in distance at most $r$ from some vertex in the range of $v$,
	\item \emph{(Determinacy)} For every formula $\phi$ in the signature of $C$-colored graphs
	of quantifier rank $q$ with free variables $X$,	for any $C$-colored graph $G$, and for any two $v_1,v_2\in V(G)^X$, if $(G,v_1)$ and $(G,v_2)$ have the same quantifier rank $q$ types,
	then
	 $$G_1,v_1\models \phi\qquad\iff \qquad G_2,v_2\models \phi.$$
	 \item \emph{(Compositionality)} Suppose that $X$ is partitioned into $Y\cup Z$, 
	 and
	 for $i=1,2$,  $G_i,H_i$ are $C$-colored graphs,
			and $v_i:X\to V(G_i)$ and $w_i:Y\to V(H_i)$ are valuations.
			If $(G_1,v_1)$ and $(G_2,v_2)$ 
			have the same  quantifier rank $q$ types,
			and $(H_1,w_1)$ and $(H_2,w_2)$ 
			have the same  quantifier rank $q$ types,
			then the quantifier rank $q$ type of the disjoint union 
			$(G_1\oplus H_1,v_1\oplus w_1)$ is equal to the one of $(G_2\oplus H_2,v_2\oplus w_2)$.
	 
	 \item \emph{(Monotonicity)} If $Y\subset X$ and $v,w\in V(G)^X$ have the same quantifier rank $q$ types, then the restrictions $v|_Y, w|_Y\in V(G)^Y$ have the same quantifier rank $q$ types.1
 \end{itemize}
\end{proposition}

\cref{pro:gaifman} follows easily from  Gaifman's Locality Theorem
(the Main Theorem~in~\cite{gaifman1982local}), but we give more details below for completeness.

\begin{proof}[of~\cref{pro:gaifman}]
 Fix a set of  colors $C$ and a set of variables $X$.
For $i=1,2$, let $G_i$
be a colored graph and $v_i:X\to V(G_i)$ be a valuation.
We say that $(G_1, v_1)$ and $(G_2,v_2)$
have the same \emph{quantifier rank $q$ type} %\marginpar{also called $q$-equivalent and denoted $(G_1,\bar v_1)\equiv_q (G_2, \bar v_2)$}
if for every formula $\phi$ with  free variables $X$ and of quantifier rank $q$,
 $$G_1,v_1\models \phi\qquad\iff \qquad G_2,v_2\models \phi.$$
If $G$ is a graph colored with $s$ colors and 
 $v:X\to V(G)$ is a valuation, 
then the equivalence class of $(G, v)$ under the above equivalence relation is called the \emph{quantifier rank $q$ type} of $(G,v)$, and  the set of \emph{quantifier rank $q$ types with  free variables $X$}
is the set of all equivalence classes, denoted
$\mathrm{Tp}^{q,C}_X$.

The following lemma is standard~(see e.g. Lemma 3.13 in~\cite{libkin}),
and  yields the first condition in~\cref{pro:gaifman}.
\begin{lemma}\label{lem:q-types}
	Fix a set of colors $C$, a rank $q$ and a set of variables $X$.
	Then the set $\mathrm{Tp}^{q,C}_X$ of quantifier rank $q$ types with free variables $X$ is finite and computable.
\end{lemma}



We state the following \cref{lem:gaifman}, which is an
immediate consequence of Gaifman's Locality Theorem
(the Main Theorem~in~\cite{gaifman1982local}).
 If $G$ is a colored graph, $r\in\N$ is an integer, and $v$ is a valuation of a set of variables in $G$, then  $N^G_r[v]$ denotes the pair $(H,v)$, where $H$ is the colored subgraph of $G$
induced by the set of all vertices which are in distance at most $r$
from some vertex in the range of $v$.
% We say that a formula $\phi(\bar x)$ with $d=|\bar x|$ free variables is \emph{$q$-local} if for every colored graph $G$ and every $\bar a_1,\bar a_2\in V(G^d)$, if  $N^G_r(\bar a_1)$ and  $N^G_r(\bar a_2)$
% are isomorphic, then $G,\bar a_1\models \phi(\bar x)$ if and only if $G,\bar a_2\models \phi(\bar x)$.

\begin{lemma}\label{lem:gaifman}
	Let $\phi$ be a  formula 
	of quantifier rank $q$
	in the signature of colored graphs, with free variables $X$.
	There is a coloring $c$ which assigns 
	There is a number $r$ computable from $q$ such that 
	$G$
	
	
	Suppose $v_1,v_2$ are valuations of $X$ in $G$ such that $N^G_r[v_1]$ and $N^G_r[v_2]$ have the same quantifier rank $q$ type, where $r=7^q$. Then
 $$G,v_1\models \phi\qquad\iff \qquad G,v_2\models \phi.$$
\end{lemma}

We also use the following well-known fact about the compositionality of types 
under taking disjoint unions. The proof is a standard application of Ehrenfeucht-Fraisse games, so we only give a sketch. By $G\oplus H$ we denote the disjoint union of colored graphs $G,H$. 			Let $X,Y$ be disjoint sets of variables. 


		\begin{lemma}\label{lem:type-union}
			For $i=1,2$, let $G_i,H_i$ be colored graphs,
			and $v_i:X\to V(G_i)$ and $w_i:Y\to V(H_i)$ be valuations.
			Suppose that $(G_1,v_1)$ and $(G_2,v_2)$ 
			have the same quantifier rank $q$ type,
			and $(H_1,w_1)$ and $(H_2,w_2)$ 
			have the same quantifier rank $q$ type.
			Then the quantifier rank $q$ type of the disjoint union 
			$(G_1\oplus H_1,v_1\oplus w_1)$ is equal to the one of $(G_2\oplus H_2,v_2\oplus w_2)$. \end{lemma}
\begin{proof}[Sketch]
	The proof proceeds by applying the well-known characterization 
	of quantifier rank $q$  types using Ehrenfeucht-Fraisse games (see e.g. Theorem 3.9 in~\cite{libkin}). By assumption, duplicator has a winning strategy $\gamma$ in the $q$-round game on $(G_1,v_1)$ and $(G_2,v_2)$, and a winning strategy $\eta$ in the $q$-round game on $(H_1,w_1)$ and $(H_2,w_2)$. The strategies $\gamma$ and $\eta$ can be combined into a winning strategy on $(G_1\oplus H_1,v_1\oplus w_1)$  and $(G_2\oplus H_2,v_2\oplus w_2)$.
\end{proof}

This finishes the proof of~\cref{pro:gaifman}.
\end{proof}

\medskip
To prove \cref{pro:crossing}, we will introduce the following notation allowing to translate a first order formula~$\phi$ talking about a graph $G$ into an equivalent formula talking 
about a suitably colored  graph $G$ with the set of vertices $S$ removed.

Let $G$ be a graph and $S\subset V(G)$
be a set of its vertices.
Define the structure $G^{S}$
as the graph $G-S$, colored with colors $\set{C_s}_{s\in S}$,
where for each $s\in S$, a vertex $v\in V(G)-S$
is colored with color $C_s$ if and only if $v$ is a neighbor of $s$
in $G$.

Fix a formula $\phi$ with free variables $X$.
If $G$ is a (colored) graph, $S\subset V(G)$ a set of vertices and $Y$ is a set of variables disjoint from $V(G)$, then 
a \emph{partial valuation} in $Y\cup S$ is a 
function $\alpha\colon X\to Y\cup S$.
If $v\from Y\to V(G)$ is a valuation and $\alpha$ is as above,
then by $\alpha\cdot v$ we denote the valuation of $X$ in $V(G)$
which maps $x\in X$ to $\alpha(x) $ if $\alpha(x)\in S$
and to $v(\alpha(x))$ if $\alpha(x)\in Y$.
By $\phi^{\alpha}$ we denote the \emph{partially valuated} formula -- formally, the pair $(\phi,\alpha)$ -- whose semantics is defined so that for a valuation $v:Y\to V(G)$, 
$$G,v\models \phi^{\alpha}\quad\Leftrightarrow \quad G,\alpha\cdot v\models \phi.$$
Intuitively $\phi^\alpha$ is the formula $\phi$ with variable $x$ substituted by $\alpha(x)$,
which can be either a variable in $Y$ or a vertex in $S$, treated as a constant.


\begin{lemma}\label{lem:remove-s}Let $G,S$ be as above.	
For every formula $\phi$ with free variables $X$ and partial valuation $\alpha:X\to Y\cup S$
there is a formula $\phi'$ with free variables $Y$,
of the same quantifier rank as $\phi$ over the signature of $G^S$ 
 such that for every valuation $v$ of $Y$ in $G-S$
the following equivalence holds:
$$G,v\models\phi^{\alpha}\qquad\iff\qquad G^S,v\models\phi'.$$
\end{lemma}
\begin{proof}
The proof proceeds by induction on the structure of the formula $\phi$. 

If $\phi$ is an atomic formula $E(x,x')$ or $x=x'$ then the formula $\phi'$ is constructed by case analysis. If $\alpha(x),\alpha(x')\in Y$ then $\phi'$
is obtained from $\phi$ by substituting the variables $x,x'$ according to~$\alpha$. If  $\alpha(x),\alpha(x')\in S$ then $\phi'$ is the truth value $\bot$ or $\top$ of 
the formula $\phi$ in the graph $G$ under the valuation which maps $x$ to $\alpha(x)$ and $x'$ to $\alpha(x')$. Finally, suppose that $\alpha(x)=y\in Y$ and $\alpha(x')=s\in S$. If $\phi$ is $E(x,x')$ then $\phi'$ is the formula $C_{s}(y)$, and if $\phi$ is $x=x'$ then $\phi'$ is the formula $\bot$.
 
 

%
% then, depending on whether $\alpha(x),\alpha(x')$ belong to $Y$ or to $S$, we consider  the appropriate case in the list below, where $y,y'$ range over $Y$ and $s,t$ range over $S$:
% \begin{enumerate}
% 	$E(y,y')\mapsto E(y,y')$
%
% 	\item If $\alpha(x)=y$ and $\alpha(x')=y'$ then $\phi'$ is $E(y,y')$.
% 	\item If $\alpha(x)=y$ and $\alpha(x')=s$ then $\phi'$ is $C_s(y)$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=y'$ then $\phi'$ is $C_s(x')$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=t$ then $\phi'$ is $\top$ if $s$ and $t$ are adjacent in $G$ and $\bot$ otherwise.
% \end{enumerate}
% We proceed similarly when $\phi$ is an atomic formula $x=x'$:
% \begin{enumerate}
% 	\item If $\alpha(x)=y$ and $\alpha(x')=y'$ then $\phi'$ is $y=y'$.
% 	\item If $\alpha(x)=y$ and $\alpha(x')=s$ then $\phi'$ is $\bot$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=y'$ then $\phi'$ is $\bot$.
% 	\item If $\alpha(x)=s$ and $\alpha(x')=t$ then $\phi'$ is $\top$ if $s=t$ are adjacent in $G$ and $\bot$ otherwise.
% \end{enumerate}





For the inductive step, we consider two cases.
If $\phi$ is a boolean combination of formulas $\phi_1,\ldots,\phi_k$, then 
apply the inductive assumption to each formula $\phi_i$,
yielding formulas $\phi_1',\ldots,\phi_k'$. Then let $\phi'$ be the analogous boolean combination of the formulas $\phi_1',\ldots,\phi_k'$.

Finally, suppose that $\phi$ is of the form $\exists x.\psi$, where   $Y$ are the free variables of $\phi$ and $x\not \in Y$.
 For $w$ being either the variable $x$ 
or an element $s\in S$, 
let $\psi^w$ be the formula obtained from the inductive assumption applied to the formula $\psi$ 
and partial valuation $\alpha$ extended to a valuation which maps  $x$ to $w$. 
Then let $\phi'$
be the formula $\exists x.\psi^x \lor \bigvee_{v\in S}\psi^v$.
The case of $\forall$ is dual.

In each case, it follows from the inductive assumption that $\phi'$ 
satisfies the required condition.
\end{proof}


Fix a graph $G$  and a set of vertices  $S\subset V(G)$.
Let $X$ be a set of variables.
For a valuation  $v$ of $X$ in $G$, we define 
the {$S$-decomposition} of $v$,  
as the (essentially unique) pair $(\alpha,v^S)$
such that $\alpha\from X\to Y\cup S$ is a partial valuation
for some set of variables $Y$,
and $v^S\from Y\to \rg(v)-S$ is a bijective valuation such that 
$\alpha\cdot v^S=v$ (where $\rg(v)$ is the range of $v$). The formal definition is as follows.

% Let $\sim$ be the partial equivalence on $X$ defined so that
% $x\sim x'$ if and only if both $x$ and $x'$ are mapped to the same element of $Y$.
% In other words, $\sim$ is the restriction of the kernel of $v$ to $v^{-1}(Y)$.
Let $Y=\set{v^{-1}(\set u): u\in \rg(v)-S}$. We treat $Y$ as a set of variables. Note that $Y$ is in bijection with $\rg(v)-S$, but we prefer 
to define $Y$ in a way which is independent of the elements of $G-S$ for technical reasons.
Define the partial valuation $\alpha\from X\to Y\cup S$
by letting $\alpha(x)$ be $v(x)$ if $v(x)\in S$,
and $v^{-1}(\set u)$ if $v(x)=u$ for some $u\in \rg(v)-S$.
Finally, let $v^S$ be the valuation of $Y$ in $G$ which
maps  $v^{-1}(\set u)$ to $u$, for $u\in \rg(v)-S$.
It is easy to see that $v=\alpha\cdot v^S$ and $v^S$ is a bijection from $Y$ 
to $\rg(v)-S$. We call the pair $(\alpha,v^S)$ the \emph{$S$-decomposition of $v$}.



For a number $q$, the \emph{$(q,S)$-local type} of a valuation $v$ of $X$ in $G$
is the pair $(\alpha,\tau)$,
where $(\alpha,v^S)$ is the $S$-decomposition of~$v$
and $\tau$ is the quantifier rank $q$
type of  $N^r_{G^S}[v^S]$ for $r=7^q$.
Note that the number of $(q,S)$-local types of valuations from $X$
in arbitrary graphs is bounded by ยง
$(s+d)^d\cdot |\mathrm{Tp}^{q,s}_{X}|$,
where $d=|X|$, $s=|S|$ and $\mathrm{Tp}^{q,s}_{X}$
is the set of quantifier rank $q$ types of 
with free variables $X$ for graphs colored using $s$ colors.




\begin{lemma}\label{lem:coloring}
	Let $\phi$ be a formula with
free variables $X$, of quantifier rank $q$.
	Suppose that $u$~and~$v$ are two valuations of $X$  in $G$ of the same $(q,S)$-local types.
	Then $$G,u\models \phi\qquad \iff\qquad G,v\models \phi.$$
\end{lemma}
\begin{proof}
Let $(\alpha,\tau)$ be the $(q,S)$-local type of the valuations $u$ and $v$, where $\alpha:X\to Y\cup S$ for some set of variables $Y$. Let $(\alpha,u^S)$ be the $S$-decomposition of $u$
and let $(\alpha,v^S)$ be the $S$-decomposition of $v$.
	Consider the formulas $\phi^{\alpha}$ and $\phi'$ as described in \cref{lem:remove-s}, both with free variables $Y$.
	In particular, the following equivalences hold:
	\begin{align*}
	G,u\models\phi\iff G,u^S\models\phi^{\alpha}\iff G^S,u^S\models\phi',\\
	G,v\models\phi\iff G,v^S\models\phi^{\alpha}\iff G^S,v^S\models\phi'.
	\end{align*}
		Note that $\phi'$ has the same quantifier rank as  $\phi$, that is, $q$.
		Since $u$ and $ v$ have the same $(q,S)$-local type $\tau$, it follows that $N^r_{G^S}[u^S]$ and $N^r_{G^S}[v^S]$ have the same quantifier rank $q$ type.
		By \cref{lem:gaifman} applied to $G^S$, $\phi'$, $ u^S$, and $v^S$, we infer that $G^S,u^S\models\phi'$ if and only if $G^S,v^S\models\phi'$.
		The lemma follows by combining this with the above equivalences.
\end{proof}

% For a graph $G$, a set of vertices $S\subset V(G)$, a set of variables $X$, and  valuations $u,v$ of $X$ in $G$, we say that $u,v$ are mutually $2r$-independent in $G-S$
% if, when treating $u$ and $v$ as  tuples of length $|X|$,
% the set  $\set{u,v}$ is mutually $2r$-independent in $G-S$.


% \begin{lemma}\label{lem:crossing}	Let $\phi$ be a formula with
% 	 whose set of free variables $X$ is partitioned into  disjoint sets $Y,Z$.
% Let $u$ and $v$ be valuations of $X$ in $G-S$ which, treated as tuples,
% are mutually $2r$-independent in $G-S$, i.e.,  $u(x)$ and $v(x')$ are at distance larger than $2r$ in the subgraph of $G$ induced by $V(G)-S$,
% for $x,x'\in X$.
% Let $u_Y$ and $u_Z$ be the restrictions of $u$ to $Y$ and $Z$ respectively,
% and let $v_Y$ and $v_Z$ be the restrictions of $v$ to $Y$ and $Z$ respectively.
%   Suppose that $u_Y$ and $v_Y$ have the same $q$-local type, and that $u_Z$ and $v_Z$ have the same $q$-local type. Then
%   the valuations $u_Y\oplus v_Z$ and $v_Y\oplus v_Z$
%   of $X$ in $G-S$
%   have the same $q$-local types. In particular,
% $$G,u_Y\oplus v_Z\models \phi\iff G,v_Y\oplus v_Z\models \phi.$$
% \end{lemma}
We are now ready to prove~\cref{pro:crossing}.
\begin{proof}[of~\cref{pro:crossing}]
	Fix a graph $G$, a  set of its vertices $S$ and a formula $\phi$
	with free variables $X$ and quantifier rank $q$. Let $r=7^q$.
	For a tuple $v\in V(G)^Y$, define the \emph{color} of $v$
	as the $(q,S)$-local type of $v$. It is clear that the first two conditions of~\cref{pro:crossing} are satisfied. We verify the last condition. 
	
Let $u,v\in V(G)^X$ be mutually $2r$-independent in $G-S$,
and of the same $(q,S)$-local type.

Since $\set{u,v}$ is mutually $2r$-independent in $G-S$, it follows that in $G^S$, every vertex appearing in $\rg \bar u^S$ is at distance larger than $2r$ from every vertex appearing in $(\bar v')^S$,
in particular vertices appearing in $\bar u^S$ are pairwise distinct from vertices appearing in $(\bar v')^S$.
Similarly for $(\bar u')^S$ and $\bar v^S$. Since pairs $\bar u,\bar u'$ and $\bar v,\bar v'$ have the same $q$-local types, we have $\alpha(\bar u)=\alpha(\bar u')$ and $\alpha(\bar v)=\alpha(\bar v')$.
From the above facts it follows that $(\bar u\bar v')^S=\bar u^S(\bar v')^S$, $(\bar u'\bar v)^S=(\bar u')^S\bar v^S$, and $\alpha(\bar u\bar v')=\alpha(\bar u'\bar v)$.
We are left with verifying that the quantifier rank $q$ types of $N^r_{G^S}[(\bar u\bar  v')^S]=N^r_{G^S}[\bar u^S(\bar  v')^S]$ and $N^r_{G^S}[(\bar u'\bar v)^S]=N^r_{G^S}[(\bar u')^S\bar  v^S]$ are equal, 
as then it suffices to apply \cref{lem:coloring}.

Since in $G^S$ each vertex appearing in $u^S$ is at distance more than $2r$ from each vertex appearing in $(\bar v')^S$, the $r$-neighborhood in the graph $G^S$
of the tuple $\bar u^S(\bar v')^S$
is the disjoint union of the $r$-neighborhoods
of the tuples $\bar u^S$ and $(\bar v')^S$.
Similarly, the $r$-neighborhood in $G^S$
of the tuple $(\bar u')^S\bar v^S$
is the disjoint union of the $r$-neighborhoods
of the tuples $(\bar u')^S$ and $\bar v^S$.
By assumption we have that $\bar u$ and $\bar u'$ have the same $q$-local types,
and similarly $\bar v$ and $\bar v'$ have the same $q$-local types.
It follows then from \cref{lem:type-union} that
the quantifier rank $q$ type of $N^r_{G^S}[\bar u^S(\bar  v')^S]$ is equal to the quantifier rank $q$ type of 
$N^r_{G^S}[(\bar u')^S\bar  v^S]$, hence we are done.
\end{proof}



We conclude by proving \cref{thm:new-stable}, promised in \cref{sec:intro}, which follows by tracking the precise dependencies on the parameters in the proof of \cref{thm:uqw-stable}.

\begin{proof}[of \cref{thm:new-stable}]
	Let $\phi(\bar x,\bar y)$ be the given formula with $d$ free variables and quantifier rank $q$. Let $d_1$ and $d_2$ denote the lengths of $\bar x$ and $\bar y$, respectively; then $d=d_1+d_2$.
	Denote $r=7^q$. We take $g(q)=6r=6\cdot 7^q$, so from now on we assume that $K_t\not\minor_{6r} G$.

We first examine \cref{prop:uqw-tuples}, and in particular the dependence of the yielded functions 
$N^d(\cdot,\cdot)$ and $s^d(\cdot)$ on the assumed quasi-wideness properties of the class $\CCC$.
More precisely, having assumed that the underlying class $\CCC$ is quasi-wide with functions $N(\cdot,\cdot)$ and $s(\cdot)$,
we obtained:
$$
N^d(2r,m)=K(4r,m(d^2+1))\qquad\textrm{and}\qquad s^d(2r)=d\cdot s(4r),
$$
where $K(4r,m')$ is the $d$-fold composition of the function $f(m')=N(4r,m')\cdot m'$.
Thus, when establishing the values of $N^d(2r,m)$ and $s^d(2r)$, we refer to the quasi-wideness of $\CCC$ only by using numbers $s(4r)$ and $N(4r,m')$ for $m'\in \N$.
By \cref{thm:new-uqw}, it suffices to assume that $K_t\not\minor_{6r} G$ to have $s(4r)\leq t$ and $N(4r,m')\leq c(r,t)\cdot (m')^{(6t+3)^{4r}}$ for some computable function $c(r,t)$.
Hence, this supposition alone, instead of full quasi-wideness of $\CCC$, is sufficient to claim that the conclusion of \cref{thm:new-uqw} holds with
$s^d(2r)$ bounded by a computable function of $t$, $d$, and $q$, and $N^d(2r,m)$ bounded by a computable function of $m$, $t$, $d$, and $q$.

	In the proof of \cref{thm:uqw-stable} we have introduced the following parameters:
	\begin{eqnarray*}
	s=s^d(2r), \qquad T_i\le (s+d_i)^{d_i}\cdot |\mathrm{Tp}_{d_i}^{q,s}|\ \textrm{ for $i=1,2$},\qquad\textrm{and}\qquad m=T_1T_2+1.
	\end{eqnarray*}
	As we argued, $s$ is bounded by a computable function of $t$, $d$, and $q$.
	It is well known that given $d_1,d_2,q,s$, one can compute the number of quantifier rank $q$ types $|\mathrm{Tp}_{d_1}^{q,s}|$ and $|\mathrm{Tp}_{d_2}^{q,s}|$; see e.g.~\cite{libkin}.
	Thus, $m$ is also bounded by a computable function of $t$, $d$, and $q$.
	
Finally, in the proof of \cref{thm:uqw-stable} we have argued that the ladder index of $\phi(\bar x,\bar y)$ is bounded by $N^d(2r,m)$, and the only reference to the quasi-wideness of $\CCC$ in the proof
is by invoking \cref{prop:uqw-tuples}.
As we argued above, in \cref{prop:uqw-tuples} it suffices to assume $K_t\not\minor_{6r} G$ to claim that $N^d(2r,m)$ is bounded by a computable function of $m$, $t$, $d$, and $q$.
Since $m$ is bounded by a computable function of $t$, $d$, and $q$, the obtained upper bound on the ladder index of $\varphi$ depends in a computable way on $t$, $d$, and $q$,
and to derive it we only need to assume that $K_t\not\minor_{6r} G$. This concludes the proof.
\end{proof}

\begin{comment}
$N(\cdot,\cdot)$ be the function given by \cref{thm:new-uqw}.
	Following the proof of \cref{prop:uqw-tuples}, we see that for the functions $N^d(r,m)$ and $s^d(r)$, we can take the following functions:%
		\newcommand{\pow}{\ \uparrow\ }%
	\begin{align*}
	 N^d(r,m)&= c\cdot (m d)\pow(2(t+4))\pow(d(t+2r)),\\
	  s^d(r)&= d\cdot t,
	\end{align*}
where $x\pow y$ denotes $x^y$ and associates to the right, i.e., $x\pow y\pow z=x^(y^z)$.
In particular, the proof of \cref{prop:uqw-tuples} shows the following property
($\ast$)
for every graph $G$ such that $K_t\not\minor_{3r+1} G$ 
and for every set of $d$-tuples $A\subset V(G)^d$ of size at least $N^d(r,m)$
there is a subset $B\subset A$ of size $m$ and $S\subset V(G)$ of size at most $s^d(r)$
such that $B$ is mutually $r$-independent in $G-S$.

	
As in the proof of \cref{thm:uqw-stable}, let $r=7^q$,  
$s=s^d(2r)=d\cdot t$,  $T=(s+d)^d\cdot |\mathrm{Tp}_d^{q,s}|$ and $m=T+1$.



Let $\cal C$ be the class of all graphs $G$
such that $K_t\not\minor_{3r+1} G$, i.e., $K_t\not\minor_{3\cdot 7^q+1} G$. We repeat the argument presented in the second paragraph of the proof of \cref{thm:uqw-stable}, and assume that there is a $\phi$-ladder in $G\in \cal C$ of length larger than $N^d(2r,m)$.
 Instead of applying \cref{prop:uqw-tuples} we apply  ($\ast$) above
and obtain sets  $S$ and $B$ with the required properties. As before, this yields a contradiction. 


In particular, every $\phi$-ladder in a graph $G\in \cal C$ has length at most $N^d(2r,m)$, 
which is at most $$c'\cdot (d^{d+1}\cdot (t+1)^d\cdot |\mathrm{Tp}_d^{q,d\cdot t}|)\pow(2t+8)\pow(d\cdot t+2d\cdot 7^q),$$
where $c'$ is some constant.
As the number $|\mathrm{Tp}_d^{q,s}|$ is computable given $d,q,s$, this 
 yields \cref{thm:new-stable}.
\end{proof}
\end{comment}
