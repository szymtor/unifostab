
\section{From uniform quasi-wideness to stability}\label{sec:stable}

In this section we focus on proving the following result, observed earlier by Adler and Adler~\cite{adler2014interpreting}.

\begin{theorem}\label{thm:uqw-stable}
	Let $\cal C$ be a uniformly quasi-wide class of graphs.
	Then $\cal C$ is stable. % More precisely, if $\phi(\bar u,\bar v)$ is a formula with $d$ free variables and quantifier rank $q$, and $N^d(r,m)$ and $s^d(r)$ are as in Proposition~\ref{prop:uqw-tuples}, then for all graphs $G\in\cal C$,  the ladder index of $\phi$ is at most $N^d(2r,(2T)^d)$,
% where $r= 7^q$,
%  $T$ is the number of all quantifier rank $q$ types with one free  variable over the signature of  graphs colored with $s^d(2r)$ colors.
\end{theorem}

Note that \cref{thm:uqw-stable} is implied by \cref{thm:new-stable}, and is weaker in the following sense: \cref{thm:new-stable} asserts in addition that there is a computable bounds on the ladder index
of any formula that depends only on the size of an excluded clique minor on a levels bounded in terms of formula's quantifier rank and number of free variables. At the end of the proof we argue that
the obtained bounds in fact also imply the stronger statement of \cref{thm:new-stable}, but for the clarity of presentation we find it more instructive to work with the cleaner formulation of \cref{thm:uqw-stable}.

The plan is as follows. In \cref{sec:uqw-tuples} we formulate a variant of uniform quasi-wideness tailored to tuples of vertices. Using this and Gaifman's Locality Theorem, we prove \cref{thm:uqw-stable} in \cref{sec:uqw-stable}.


\subsection{Uniform quasi-widness for tuples}\label{sec:uqw-tuples}
Fix a graph $G$, the dimension $d\in\N$, and the radius $r\in \N$.
If $S\subset V(G)$ is a set of vertices and $A\subset V(G)^d$ is a set of $d$-tuples of vertices,
then we say that $A$ is \emph{mutually $r$-independent} in $G-S$ 
if for every two distinct $(u_1,\ldots,u_d),(v_1,\ldots,v_d)\in A$
and for all $1\le i,j\le d$, the distance between the vertices $u_i$ and $v_j$ in the graph $G-S$
is larger than $r$. Throughout this section we use the convention that if $x\in S$, then the distance in $G-S$ between $x$ and any vertex, including $x$ itself, is infinity. 
For instance, in the definition above, the tuples from $A$ may contain vertices of~$S$, and such a vertex is considered infinitely far from every vertex.

We not prove the following proposition, which can be viewed as an extension of uniforma quasi-wideness to tuples.
The proof is based on translating the approach of Podewski and Ziegler~\cite{podewski1978stable} to the finite.

\begin{proposition}\label{prop:uqw-tuples}
	Let $\cal C$ be a uniformly quasi-wide class of graphs and $d\in\N$ be an integer.
	Then there are functions $N^d\colon \N\times\N\to\N$ and $s^d\colon \N\to\N$
	such that for all $r,m\in\N$ and all subsets $A\subset V(G)^d$
	with $|A|\ge N^d(r,m)$ there  is a set $S\subset V(G)$
	of size $|S|\le s^d(r)$ and a subset $B\subset A$ of size $|B|\ge m$ which is mutually $r$-independent in $G-S$.
\end{proposition}

The rest of this section is devoted to the proof of \cref{prop:uqw-tuples}.
Fix a uniformly quasi-wide class $\cal C$ and functions $N:\N\times\N\to \N$
	and $s:\N\to\N$ as in the definition of uniform quasi-wideness.
	Let $d\in \N$ be a fixed dimension.
		For a fixed graph $G\in \cal C$  and
	  coordinate $i\in\set{1,\ldots,d}$, let $\pi_i$ denote the projection from $V(G)^d$ onto the $i$th coordinate.

	


\begin{lemma}\label{lem:step1} For any $r,m\in \N$ there is an integer $K(r,m)$ such that
	for any given $A\subset V(G)^d$ with $|A|\ge K(r,m)$,
	there is a set $B\subset A$ with $|B|\ge m$ and a set $S\subset V(G)$ with $|S|\le d\cdot s(r)$, 
	such that for each coordinate $i\in\set{1,\ldots,d}$ and all distinct $\bar x,\bar y\in B$,
 $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at distance greater than $r$ in $G-S$. 
\end{lemma}
\begin{proof}
We will iteratively apply the following claim.

%Let $f\colon \N\to \N$ be defined as $f(m)=N(r,m)\cdot m$ for $m\in\N$.

\begin{claim}\label{claim:ith-coord}
Fix a coordinate $i\in\set{1,\ldots,d}$, an integer $m'\in\N$, and a  set $A'\subset V(G)^d$ with  $|A'|\ge N(r,m')\cdot m'$.
Then there is a set $B'\subset D$ with $|B'|\ge m'$
and a set $S'\subset V(G)$ with $|S'|\le  s(r)$, such that for all distinct $\bar x,\bar y\in B$,
 $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at distance greater than $r$ in $G-S$. 
\end{claim}
\begin{clproof}
We consider two cases.

If $\pi_i(A')\subset V(G)$ has at least $N(r,m')$ elements, then we apply the definition of uniform quasi-wideness to $\pi_i(A')\subset V(G)$. This yields sets $S'\subset V(G)$ and $B''\subset \pi_i(A')$
such that $|B''|\ge m'$, $|S'|\le s(r)$, and $B''$ is $r$-independent in $G-S'$. 
Let $B'\subseteq A'$ be a subset of tuples constructed as follows: for each $u\in B''$, include in $B'$ one arbitrarily chosen tuple $\bar x\in A'$ such that $\pi_i(\bar x)=u$.
Clearly $|B'|=|B''|\ge m'$ and for all distinct $\bar x,\bar y\in B'$, we have that $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are distinct and at distance greater than $r$ in $G-S$; this is because $B''$ is $r$-independent
in $G-S$. Hence $B'$ and $S'$ satisfy all the required properties.

If $\pi_i(A')$ has less than $N(r,m')$ elements, then choose the element $a\in\pi_i(A')$ whose inverse image $\pi_i^{-1}(\set a)\cap A'$ has the largest cardinality. Let $S'=\set{a}$ 
and let $B'=\pi_i^{-1}(\set a)$. Then $$|B'|\ge \frac{|A'|}{|\pi_i(A')|}\ge \frac{|A'|}{N(r,m')}\ge \frac {N(r,m')\cdot m'}{N(r,m')}=m',$$
and $|S'|=1$. Observe that $\pi_i(\bar x)=a$ for all $\bar x\in A'$. As $a\in S$, by the adopted convention we have that $\pi_i(\bar x)$ and $\pi_i(\bar y)$ are at infinite distance for all distinct $\bar x,\bar y\in B$.
\end{clproof}

We proceed with the proof of \cref{lem:step1}.
Let $f(m')=N(r,m')\cdot m'$ for $m'\in\N$; by $f^k$ we denote the $k$-fold composition of $f$ with itself.
Let $A\subset V(G)^d$ be such that $|A|\ge f^d(m)$. 
Define $B_0=A$, $S_0=\emptyset$, and for $i=1,\ldots,d$,
let $B_{i}$ and $S_i$ be the $B'$ and $S'$ obtained from \cref{claim:ith-coord} applied to the set of tuples $B_{i-1}\subset V(G)^d$, the coordinate $i$, and $m'=f^{d-i}(m)$. 
The invariant is that $|B_i|\ge f^{d-i}(m)$.
In particular, 
taking $B=B_d$ and $S=S_1\cup\ldots \cup S_d$, we obtain that $|B|\ge m$ and $|S|\le d\cdot s(r)$, and, by construction, $\pi_i(B)$
is $r$-independent in $G-S$ for every coordinate $i\in\set{1,\ldots,d}$. Letting $K(r,m)=f^d(m)$ yields the lemma.
\end{proof}


\begin{lemma}\label{lem:step2}
	Let $B\subset V(G)^d$ and $S\subset V(G)$ be such that \begin{itemize}
	\item for all $i\in \set{1,\ldots,d}$,
	$\pi_i(B)$ is $2r$-independent in $G-S$, and 
	\item for each tuple $\bar a\in B$, the set of entries of $\bar a$ is $r$-independent in $G-S$.  
	\end{itemize}
	Then there is a set $C$ with $C\subset B$ 
	such that $C$ is mutually $r$-independent in $G-S$
	and $|C|\geq\frac{|B|}{d^2+1}$.
\end{lemma}
\begin{proof}
We construct a sequence of $C_0\subset C_1\subset \ldots$ of subsets of $B$ which are mutually $r$-independent in $G-S$, as follows.

We start with $C_0=\emptyset$. Suppose that $C_s\subset B$ is 
 already constructed for some $s\ge 0$
 and is mutually $r$-independent in $G-S$; we construct $C_{s+1}$. With each element $a\in B-C_s$,
we associate an arbitrarily chosen function $f_a\colon \set{1,\ldots,d}^2\to C_s\cup \set{\bot}$
with the following properties:
\begin{itemize}
	\item If $f_a(i,j)=b$ then the $i$th coordinate of $a$
	and the $j$th coordinate of $b$ are at distance at most $r$
	in $G-S$.
	\item If $f_a(i,j)=\bot$ then there is no element $b\in C_s$ 
	such that the $i$th coordinate of $a$ and the $j$th coordinate of $b$ are at distance at most $r$ in $G-S$.	
\end{itemize}
Observe that whenever $a_1, a_2$ are two distinct elements of $B-C_s$,
then for all $i,j\in \set{1,\ldots,d}^2$, the values $f_{a_1}(i,j)$ and $f_{a_2}(i,j)$
cannot be equal to the same element $b\in C_s$:
otherwise, we would have that the $i$th coordinate of $a_1$
and the $i$th coordinate of $a_2$ are at distance at most $2r$
in $G-S$, which is impossible by the assumption on $B$.
In particular, if $|B-C_s|> |C_s|\cdot d^2$
then there must be some element  $a\in B-C_s$  
such that $f_a(i,j)=\bot$  for all $i,j\in\set{1,\ldots,d}$.
Let $C_{s+1}=C_s\cup \set s$.
By construction, $C_{s+1}$ is mutually $r$-independent in $G-S$.

We may repeat the construction as long as $|B|>|C_s|\cdot (d^2+1)=s\cdot (d^2+1)$, and we stop when this inequality no longer holds. Define the set $C$ as the last constructed set $C_s$.
By construction, $|C_s|=s\ge 
\frac{|B|}{d^2+1}$.	
\end{proof}

To finish the proof of \cref{prop:uqw-tuples},
given a set $A\subset V(G)^d$ and integers $r,m\in\N$,
first apply 
\cref{lem:step1} 
  with $r'=2r$ and
 $m'= m\cdot (d^2+1)$.
 Assuming that $|A|\ge K(r',m')$, 
we obtain a set $B\subset A$ with $|B|\ge m\cdot (d^2+1)$ and a set $S\subset V(G)$ with $|S|\le s(2r)$.
Apply \cref{lem:step2} to $B$ and $S$, yielding a set $C\subset B$ which is mutually $r$-independent in $G-S$ and has size at least $m$. This concludes the proof of \cref{prop:uqw-tuples},
where the obtained bounds are $N^d(r,m)=K(r',m')=K(2r,m\cdot (d^2+1))$ and $s^d(r)=d\cdot s(2r)$.


\subsection{Excluding long ladders}
\label{sec:uqw-stable}

Before  proving \cref{thm:uqw-stable}, we recall some notions from logic, namely quantifier ranks, Gaifman's Locality Theorem, and some simple manipulations on formulas.


By a \emph{colored graph} we mean a graph  in which 
every vertex is assigned zero or more colors from a fixed set of colors. We view a colored graph as a relational structure as usual, by treating each color as a unary predicate. 

The \emph{quantifier rank} of a formula $\phi$ is the maximal number of nested quantifiers in $\phi$. Fix a set of $s$ colors.
Let $(G_1,\bar v_1)$ and $(G_2,\bar v_2)$ be two
colored graphs with distinguished tuples of vertices of the same length $d$. We say that $(G_1,\bar v_1)$ and $(G_2,\bar v_2)$
have the same \emph{quantifier rank $q$ type}
if for every formula $\phi(\bar x)$ with $d$ free variables and of quantifier rank $q$,
 $$G_1,\bar v_1\models \phi(\bar x)\qquad\iff \qquad G_2,\bar v_2\models \phi(\bar x).$$
 The equivalence class of $(G,\bar v)$ under the above equivalence relation is called the \emph{quantifier rank $q$ type} of $(G,\bar v)$, and  the set of \emph{quantifier rank $q$ types with $d$ free variables}
is the set of all equivalence classes, denoted
$\mathrm{Tp}^{q,s}_d$ (where $s$ is the number of colors).

The following lemma is standard~(see e.g. Lemma 3.13 in~\cite{libkin}).
\begin{lemma}\label{lem:q-types}
	Fix a set of $s$ colors, a rank $q$ and a number of variables $d$.
	Then the set $\mathrm{Tp}^{q,s}_d$ of quantifier rank $q$ types with $d$ free variables is finite.
\end{lemma}


Before giving a proof of \cref{thm:uqw-stable},
we state the following \cref{lem:gaifman}, which is an
immediate consequence of Gaifman's Locality Theorem
(the Main Theorem~in~\cite{gaifman1982local}).
 If $G$ is a colored graph, $r\in\N$ is an integer, and $\bar a=(a_1,\ldots,a_d)$ is a tuple of vertices of $G$, then  $N^G_r[\bar a]$ denotes the pair $(H,\bar a)$, where $H$ is the colored subgraph of $G$
induced by the set of all vertices which are in distance at most $r$
from some vertex in $\bar a$.
% We say that a formula $\phi(\bar x)$ with $d=|\bar x|$ free variables is \emph{$q$-local} if for every colored graph $G$ and every $\bar a_1,\bar a_2\in V(G^d)$, if  $N^G_r(\bar a_1)$ and  $N^G_r(\bar a_2)$
% are isomorphic, then $G,\bar a_1\models \phi(\bar x)$ if and only if $G,\bar a_2\models \phi(\bar x)$.

\begin{lemma}\label{lem:gaifman}
	Let $\phi(\bar x)$ be a  formula 
	of quantifier rank $q$
	in the signature of colored graphs. 	Then, whether a tuple $\bar a$ of vertices of $V(G)$
	satisfies the formula $\phi(\bar x)$
	depends only on the quantifier rank $q$ type of  $N^G_r[\bar a]$,
 where $r=7^q$.
\end{lemma}

We also use the following well-known fact about the compositionality of types 
under taking disjoint unions. The proof is a standard application of Ehrenfeucht-Fraisse games, so we only give a sketch. By $\oplus$ we denote the disjoint union operation on graphs.
		\begin{lemma}\label{lem:type-union}
			For $i=1,2$, let $G_i,H_i$ be colored graphs,
			and $\bar a_i$ be a tuple of vertices of $G_i$
			and $\bar b_i$ be a tuple of vertices of $H_i$.
			Suppose that $(G_1,\bar a_1)$ and $(G_2,\bar a_2)$ 
			have the same quantifier rank $q$ type,
			and $(H_1,\bar b_1)$ and $(H_2,\bar b_2)$ 
			have the same quantifier rank $q$ type.			
			Then the quantifier rank $q$ type of the disjoint union 
			$(G_1\oplus H_1,\bar a_1\bar b_1)$ is equal to the one of $(G_2\oplus H_2,\bar a_2\bar b_2)$. \end{lemma}
\begin{proof}[Sketch]
	The proof proceeds by applying the well-known characterization 
	of quantifier rank $q$  types using Ehrenfeucht-Fraisse games (see e.g. Theorem 3.9 in~\cite{libkin}). By assumption, duplicator has a winning strategy $\gamma$ in the $q$-round game on $(G_1,\bar a_1)$ and $(G_2,\bar a_2)$, and a winning strategy $\eta$ in the $q$-round game on $(H_1,\bar b_1)$ and $(H_2,\bar b_2)$. The strategies $\gamma$ and $\eta$ can be combined into a winning strategy on $(G_1\oplus H_1,\bar a_1\bar b_1)$ and $(G_2\oplus H_2,\bar a_2\bar b_2)$.
\end{proof}


\medskip
To prove \cref{thm:uqw-stable}, we will use \cref{prop:uqw-tuples} and work over a graph $G$
with a subset of vertices $S$ removed.
We will use the following notation allowing to translate a first order formula $\phi$ talking about a graph $G$ into an equivalent formula talking 
about a suitably colored  graph $G$ with the set of vertices $S$ removed.

Let $G$ be a graph and $S\subset V(G)$
be a set of its vertices.
Define the structure $G^{S}$
as the colored graph $G-S$, where for each $s\in S$, all vertices $v$
which are neighbors of $s$ in $G$ are colored with color $C_s$.

Fix a formula $\phi(\bar x)$.
Let $\bar y$ be a non-repeating tuple of variables and $\bar \alpha$ a tuple whose elements belong to $\bar y$ or $S$, of the same length as $\bar x$.
Denote by $\phi^{\bar \alpha}(\bar y)$ the formula with free variables $\bar y$ obtained from $\phi$ by substituting the variable $x_i$ with the element $\alpha_i$, 
which is either a variable in $\bar y$  or an element of $S$, intepreted as a constant in the formula. 


\begin{lemma}\label{lem:remove-s}Let $G,S$ be as above.	
For every formula $\phi(\tup{x})$ and tuples $\bar y,\bar\alpha$ as above,
there is a formula $\phi'(\bar y)$ 
of the same quantifier rank as $\phi$ over the signature of $G^S$ 
 such that for every tuple $\tup{a}$ of vertices of $G-S$
 of the same length as $\bar y$,
the following equivalence holds:
$$G\models\phi^{\bar\alpha}(\tup{a})\qquad\iff\qquad G^S\models\phi'(\tup{a}).$$
\end{lemma}
\begin{proof}
The proof proceeds by induction on the structure of the formula $\phi$. If $\phi$ is an atomic formula,
then $\phi^{\bar \alpha}(\bar y)$ is also an atomic formula, and, depending on its form, 
we consider the appropriate case below. Below, $x$ ranges over variables in $\bar y$
and $s,t$ range over elements of $S$.
\begin{enumerate}
	\item If $\phi^{\bar \alpha}(\bar y)$ is $E(x,s)$, 
then let $\phi'$ be the formula $C_s(x)$.
\item If $\phi^{\bar \alpha}(\bar y)$ is $x=s$, then let $\phi'$
be the formula $\bot$. 
	\item If $\phi^{\bar \alpha}(\bar y)$ is $E(s,t)$, 
then let $\phi'$ be the formula $\top$ if $s$ and $t$ are adjacent in $G$, and $\bot$ otherwise. 
	\item If $\phi^{\bar \alpha}(\bar y)$ is $s=t$, 
then let $\phi'$ be the formula $\top$ if $s=t$ and $\bot$ otherwise. 
\end{enumerate}

For the inductive step, we consider two cases.
If $\phi$ is a boolean combination of formulas $\phi_1,\ldots,\phi_k$, then 
apply the inductive assumption to each formula $\phi_i$,
yielding formulas $\phi_1',\ldots,\phi_k'$. Then let $\phi'$ be the analogous boolean combination of the formulas $\phi_1',\ldots,\phi_k'$.

Finally, suppose that $\phi$ is of the form $\exists x.\psi(\bar y x)$, where $x$ is not free in $\phi$. For $v$ being either the variable $x$ 
or an element $s\in S$, 
let $\psi^v(\bar y)$ be the formula obtained from the inductive assumption applied to the formula $\psi(\bar y x)$ 
and tuple $\bar \alpha$ with the element $v$ appended to it.
Then let $\phi'(\bar y)$
be the formula $\exists x.\psi^x(\bar yx)\lor \bigvee_{v\in S}\psi^v(\bar y)$.
The case of $\forall$ is dual.

In each case, it follows from the inductive assumption that $\phi'$ 
satisfies the required condition.
\end{proof}

Fix a graph $G$  and a set of vertices  $S\subset V(G)$.
% To each  vertex $v$ of $G$
% assign a \emph{color} which is equal to $v$ if $v\in S$,
% and otherwise, the color of $v$ is the quantifier rank $q$ type of  $N^r_{G^S}[v]$.
%
Let $y_1,\ldots,y_d$ be distinct variables.
For a tuple $\bar w=(w_1,\ldots,w_d)\in V(G)^d$, let 
$\alpha(\bar w)$ denote the sequence 
 $(\alpha_1,\ldots,\alpha_d)$,
 where $\alpha_i$ is the variable $y_j$
 if $w_i\not\in S$ and $j\ge 1$  
 is the smallest number such that $w_j=w_i$,
 and $\alpha_i$ is $w_i$ if $w_i\in S$.
Let $\bar w^S$ denote the sequence of vertices
which occur in the sequence $\bar w$ and not in $S$, and with repetitions removed.
For a number $q$, the \emph{$q$-local type} of a tuple $\bar w\in V(G)^d$
is the pair $(\alpha(\bar w),\mathrm{tp}(\bar w^S))$,
where $\mathrm{tp}(\bar w^S)$ is the quantifier rank $q$
type of  $N^r_{G^S}[\bar w^S]$, where $r=7^q$.
Note that the number of $q$-local types is bounded by 
$(s+d)^d\cdot |\mathrm{Tp}^{q,s}_{d}|$,
where $\mathrm{Tp}^{q,s}_{d}$
is the set of quantifier rank $q$ types of 
with $d$ free variables for graphs colored using $s$ colors.




\begin{lemma}\label{lem:coloring}
	Let $\phi(\bar x)$ be a formula with
	 $d$ free variables and of quantifier rank $q$.
	Suppose that $\bar u$ and $\bar v$ are two  $d$-tuples of 
	vertices of $V(G)$ such that  $\bar u$ and $\bar v$ have the same $q$-local types. Then $$G,\bar u\models \phi(\bar x)\iff G,\bar v\models \phi(\bar x).$$
\end{lemma}
\begin{proof}
Let $(\bar \alpha,\tau)$ be the $q$-local type of the tuples $\bar u$ and $\bar v$.
	Consider the formulas $\phi^{\bar \alpha}(\bar y)$ and $\phi'(\bar y)$ as described in Lemma~\ref{lem:remove-s}.
	In particular, the following equivalences hold:
	\begin{align*}
	G\models\phi(\bar u)\iff G\models\phi^{\bar\alpha}(\bar u^S)\iff G^S\models\phi'(\bar u^S),\\
	G\models\phi(\bar v)\iff G\models\phi^{\bar\alpha}(\bar v^S)\iff G^S\models\phi'(\bar v^S).
	\end{align*}
		Note that $\phi'$ has the same quantifier rank as $\phi^{\bar \alpha}$, which, in turn, is the same as the quantifier rank of $\phi$, i.e., $q$. Hence, by Lemma~\ref{lem:gaifman}, by any tuple $\bar w$ of elements of $G-S$, whether $\phi'(\bar w)$ holds in $G^S$ depends only on the quantifier rank $q$ type of $N^r_{G^S}[\bar w]$. Since $N^r_{G^S}[\bar u^S]$ and $N^r_{G^S}[\bar v^S]$ have the same quantifier rank $q$ types, the  lemma follows.
\end{proof}

\begin{lemma}\label{lem:crossing}	Let $\phi(\bar x)$ be a formula with
	 $d$ free variables.
  Let $\bar u,\bar v,\bar u',\bar v'$ tuples of vertices of $G$,
  such that $|\bar u|=|\bar u'|$ and $|\bar v|=|\bar v'|$ and that $\bar u\bar v$ and $\bar u'\bar v'$ 
  are tuples of the same length $d$ and the same $q$-local type, and the set $\set{\bar u\bar v,\bar u'\bar v'}$
  is mutually $2r$-independent. Then 
  the tuples $\bar u\bar v'$ and $\bar u'\bar v$
  have the same $q$-local types. In particular, 
$$G,\bar u\bar v'\models \phi(\bar x)\iff G,\bar u'\bar v\models \phi(\bar x).$$
\end{lemma}
\begin{proof}
Since $\set{\bar u\bar v,\bar u'\bar v'}$ is mutually $2r$-independent, in particular, no vertex in $\bar u\bar v$ occurs in $\bar u'\bar v'$.
It easy to check that this implies $\alpha(\bar u\bar v')=\alpha(\bar u'\bar v)$.
Moreover, the tuple $(\bar u\bar v')^S$ as defined above 
is equal to the concatenation of the tuples $\bar u^S$
and $(\bar v')^S$.
Note that the set  $\set{\bar u^S,(\bar v')^S}$ is mutually $2r$-independent. In particular, the  $r$-neighborhood in the graph $G^S$
of the tuple $(\bar u\bar v')^S$
is the disjoint union of the $r$-neighborhoods
of the tuples $\bar u^S$ and $(\bar v')^S$.
Also, note that it follows from the assumptions that $\bar u$ and $\bar u'$ have the same $q$-local types,
and similarly, $\bar v$ and $\bar v'$ have the same $q$-local types.
It follows then from Lemma~\ref{lem:type-union} that
the quantifier rank $q$ type of $N^r_{G^S}[\bar u^S(\bar  v')^S]$ is equal to the quantifier rank $q$ type of 
$N^r_{G^S}[\bar (u')^S\bar  v^S]$. 
Together with the previous observations, this implies that the tuples $\bar u'\bar v$ and $\bar u\bar v'$
have the same $q$-local types. The last part of the statment then follows from Lemma~\ref{lem:coloring}.
\end{proof}




Finally, we prove Theorem~\ref{thm:uqw-stable}. 
\begin{proof}  

Fix a formula  $\phi$ quantifier rank $q$ and $d$ free variables.
Let $N^d(r,m)$ and $s^d(r)$ be as in Proposition~\ref{prop:uqw-tuples}.
Denote $r=  7^q$, 
and let $T$ denote the number of all $q$-local types of 
formulas with $d$ free variables over the signature of  graphs colored by $s^d(2r)$ colors. Note that $T\le (s+d)^d\cdot |\mathrm{Tp}_d^{q,s}|$, where $s=s^d(2r)$.
Let $m=T+1$. 

We show that 
every $\phi$-ladder in a graph $G\in\cal C$ has length smaller than $N^d(2r,m)$. 
To reach a contradiction, assume that there is a graph $G\in\cal C$, a number $k\ge N^d(2r,m)$
and tuples $\bar u_1,\ldots,\bar u_k\in V(G)^{\bar u}$ and $\bar v_1,\ldots,\bar v_k\in V(G)^{\bar v}$
which form a $\phi$-ladder in $G$.
	Let $A=\set{\bar u_i\bar v_i: i=1..k}\subset V(G)^d$; note that $|A|=k$.
Applying Proposition~\ref{prop:uqw-tuples} to the set $A$, the radius $2r$, and target size $m$
		 yields a set $S\subset V(G)$ such that $|S|\le s^d(2r)$
	and a set $B\subset A$ of size $m$ which is mutually $2r$-independent in $G-S$.
% Replacing $A$ by $B$, we may assume that $\bar u_1,\ldots,\bar u_m\in V(G)^{\bar u}$ and $\bar v_1,\ldots,\bar v_k\in V(G)^{\bar v}$
% form a $\phi$-ladder of length $m$ in $G$, and
% that $A$ is totally $2r$-independent in $G-S$.
%
%
% An \emph{$q$-local formula} $\phi(\bar x)$ is a
% formula such that for every colored graph $G$ and tuple of vertices $\bar a\in V(G)^{\bar x}$, the following equivalence holds:
% $$G,\bar a\models \phi\qquad\textit {if and only if }\qquad G[N^{r}(\bar a)],\bar a\models \phi.$$
%
% \begin{theorem}\label{thm:gaifman}
% 	Let $\phi(\bar x)$ be a formula over the signature of colored graphs of quantifier rank $q$.
% 	There is a  number $r\le 7^{q}$
% 	% , and $s\le q+|\bar x|$,
% 	such that $\phi$ is equivalent to a Boolean combination of sentences and $q$-local formulas $\psi^{(r)}(\bar x)$.% the following:
% % 	\begin{itemize}
% % 		\item $q$-local formulas ;
% % 		\item sentences.%  of the form $$\exists y_1,\ldots,y_s
% % % \bigwedge_{1\le i\le s} \alpha^{(r)}(y_i)\land
% % % \bigwedge_{1\le i<j\le s} d^{>2r}(y_i,y_j),$$
% % % where $\alpha^{(r)}(y)$ is $q$-local and in one variable,
% % %  and $d^{>2r}(v,w)$ expresses the property that $\set{v,w}$ is $2r$-independent.
% % 	\end{itemize}
% \end{theorem}
Since the set $B$ has $m=T+1$ elements,
and each tuple $\bar u_i\bar v_i\in B$ has an associated $q$-local type 
belonging to a set of cardinality $T$, 
by the pigeonhole principle, there are $i$ and $j$ 
with $i<j$, such that $\bar u_i\bar v_i$ and $\bar u_j\bar v_j$ 
 have the same $q$-local types. By Lemma~\ref{lem:crossing},   $\phi(\bar u_i,\bar v_j)$ holds in $G$
 if and only if $\phi(\bar u_j,\bar v_i)$ holds in $G$, which contradicts the assumption that $\bar u_1,\ldots,\bar u_m$ and $\bar v_1,\ldots,\bar v_m$ form a $\phi$-ladder.
 This finishes the proof of Theorem~\ref{thm:uqw-stable}.
\end{proof}


We now prove Theorem~\ref{thm:new-stable}.
\begin{proof}
	The proof is by tracking the precise dependencies on the parameters in the proof of Theorem~\ref{thm:new-stable}. 
	Let $\phi(\bar x)$ be a formula with $d$ free variables and quantifier rank $q$.
 Define the functions
	$s(r)=t$ and $N(r,m)=c\cdot {m^{(6t+3)}}^{t+r}$ as defined in Theorem~\ref{thm:new-uqw},
	where $c$ is some constant. 
	Following the proof of Proposition~\ref{prop:uqw-tuples}, we see that for the functions $N^d(r,m)$ and $s^d(r)$, we can take the following functions:%
		\newcommand{\pow}{\ \uparrow\ }%
	\begin{align*}
	 N^d(r,m)&= c\cdot (m d)\pow(2(t+4))\pow(d(t+2r)),\\
	  s^d(r)&= d\cdot t,
	\end{align*}
where $x\pow y$ denotes $x^y$ and associates to the right, i.e., $x\pow y\pow z=x^(y^z)$.
In particular, the proof of Proposition~\ref{prop:uqw-tuples} shows the following property
($\ast$)
for every graph $G$ such that $K_t\not\minor_{3r+1} G$ 
and for every set of $d$-tuples $A\subset V(G)^d$ of size at least $N^d(r,m)$
there is a subset $B\subset A$ of size $m$ and $S\subset V(G)$ of size at most $s^d(r)$
such that $B$ is mutually $r$-independent in $G-S$.

	
As in the proof of Theorem~\ref{thm:uqw-stable}, let $r=7^q$,  
$s=s^d(2r)=d\cdot t$,  $T=(s+d)^d\cdot |\mathrm{Tp}_d^{q,s}|$ and $m=T+1$.



Let $\cal C$ be the class of all graphs $G$
such that $K_t\not\minor_{3r+1} G$, i.e., $K_t\not\minor_{3\cdot 7^q+1} G$. We repeat the argument presented in the second paragraph of the proof of Theorem~\ref{thm:uqw-stable}, and assume that there is a $\phi$-ladder in $G\in \cal C$ of length larger than $N^d(2r,m)$.
 Instead of applying Proposition~\ref{prop:uqw-tuples} we apply  ($\ast$) above
and obtain sets  $S$ and $B$ with the required properties. As before, this yields a contradiction. 


In particular, every $\phi$-ladder in a graph $G\in \cal C$ has length at most $N^d(2r,m)$, 
which is at most $$c'\cdot (d^{d+1}\cdot (t+1)^d\cdot |\mathrm{Tp}_d^{q,d\cdot t}|)\pow(2t+8)\pow(d\cdot t+2d\cdot 7^q),$$
where $c'$ is some constant.
As the number $|\mathrm{Tp}_d^{q,s}|$ is computable given $d,q,s$, this 
 yields Theorem~\ref{thm:new-stable}.
\end{proof}
