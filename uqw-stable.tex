
\section{From uniform quasi-wideness to stability}\label{sec:stable}

\subsection{Uniform quasi-widness for tuples}
Fix a graph $G$, a number $d\in\N$ (the dimension) and a number $r\in \N$ (the radius).
If $S\subset V(G)$ is a set of vertices and $A\subset V(G)^d$ is a set of $d$-tuples of vertices,
then we say that $A$ is $r$-\emph{totally independent} in $G-S$ 
if the set of all vertices $v\in G-S$ which appear on some coordinate of some tuple $\bar a\in A$
is $r$-independent in $G-S$. 


\begin{proposition}\label{prop:uqw-tuples}
	Let $\cal C$ be a uniformly quasi-wide class of graphs and $d\in\N$ a number.
	There are functions $N^d:\N\times\N\to\N$ and $s^d:\N\to \N$
	such that for all $r,m\in\N$ and all subsets $A\subset V(G)^d$
	such that $|A|\ge N^d(r,m)$ there  is a set $S\subset V(G)$
	of size $|S|\le s^d(r)$ and a subset $B\subset A$ of size $|B|\ge m$ which is totally $r$-independent in $G-S$.
\end{proposition}
\begin{proof}We fix a uniformly quasi-wide class $\cal C$ and functions $N:\N\times\N\to \N$
	and $s:\N\to\N$ as in the definition of uniform quasi-wideness.
	Let $d\in \N$ be a fixed dimension.
		For a fixed graph $G\in \cal C$  and
	  coordinate $i\in\set{1,\ldots,d}$, let $\pi_i$ denote the projection from $V(G)^d$ onto the $i$th coordinate.

	


\begin{lemma}\label{lem:step1} For any $r,m\in \N$ there is a number $K(r,m)$ such that
	for any given $A\subset V(G)^d$ with $|A|\ge K(r,m)$,
	there is a set $B\subset A$ with $|B|\ge m$, and a set $S\subset V(G)$ with $|S|\le s(r)$, 
	such that for each coordinate $i=1..d$, 
 $\pi_i(B)$ is $r$-independent in $G-S$. 
\end{lemma}
\begin{proof}

Let $f$ be the function defined so that $f(m)=N(r,m)\cdot m$ for $m\in\N$.

\begin{claim}\label{claim:ith-coord}
Fix a coordinate $i\in\set{1,\ldots,d}$, a number $m'\in\N$ and a  set $A\subset V(G)^d$ with  $|A|\ge f_r(m')$.
There is a set $B\subset A$ such that $|B|\ge m'$
and $S\subset V(G)$ such that $|S|\le s(r)$,
so that  $\pi_i(B)$ is $r$-independent in $G-S$.	
\end{claim}
To prove the claim, 
we consider two cases.
If $\pi_i(A)\subset V(G)$ has at least $N(r,m')$ elements, then we apply the definition of uniform quasi-wideness to $\pi_i(A)\subset V(G)$. Let $S\subset V(G)$ and $B'\subset \pi_i(A)$
be as in the definition, i.e., $B'$ is $r$-independent in $G-S$,
$|B'|\ge m'$ and $|S|\le s(r)$. Let $B\subset A$ be the set of all tuples 
whose $i$th coordinate belongs to the set $B'$, i.e., $B=\pi_i^{-1}(B')\cap A$.
Clearly, $|B|\ge |B'|\ge m'$, and $|S|\le s(r)$.

If $\pi_i(A)$ has less than $N(r,m')$ elements, then choose the element $a\in\pi_i(A)$ whose inverse image $\pi_i^{-1}(\set a)\cap A$ has the largest cardinality. Let $S=\set{a}$ 
and let $B=\pi_i^{-1}(\set a)$. Then $|B|\ge \frac{|A|}{|\pi_i(A)|}\ge \frac{|A|}{N(r,m')}\ge \frac {f(m')}{N(r,m')}=m'$,
and $|S|=1$. This proves Claim~\ref{claim:ith-coord}.


We now prove Lemma~\ref{lem:step1}.
Let $A\subset V(G)^d$ be such that $|A|\ge f^d(m)$. 
Define $B_0=A$, $S_0=\emptyset$, and for $i=1..d$,
let $B_{i}$ and $S_i$ be the $B$ and $S$ obtained from  Claim~\ref{claim:ith-coord} applied to the se of tuples $B_{i-1}\subset V(G)^d$, the coordinate $i$, and $m'=f^{d-i}(m)$.  The invariant is that $|B_i|\ge f^{d-i}(m)$.
In particular, 
taking $B=B_d$ and $S=S_1\cup\ldots \cup S_d$, we obtain that $|B|\ge m$ and $|S|\le d\cdot s(r)$, and, by construction, $\pi_i(B)$
is $r$-independent in $G-S$, for every coordinate $i\in\set{1,\ldots,d}$. Letting $K(r,m)=f^d(m)$ yields the lemma.
\end{proof}


\begin{lemma}\label{lem:step2}
	Let $B\subset V(G)^d$ and $S\subset V(G)$ be such that for  $i=1..d$,
	$\pi_i(B)$ is $2r$-independent in $G-S$.
	Then there is a set $C$ with $C\subset B$ 
	such that $C$ is totally $r$-independent in $G-S$
	and $|C|> \frac{|B|}{d^2}$.
\end{lemma}
\begin{proof}
We construct a sequence of sets $C_0\subset C_1\subset \ldots$ of subsets of $B$ which are totally $2r$-independent in $G-S$, as follows.

We start with $C_0=\emptyset$. Suppose that $C_s\subset B$ is 
 already constructed for some $s\ge 0$
 and is totally $2r$-independent in $G-S$; we construct $C_{s+1}$.  To each element $a\in B-C_s$,
we associate any function $f_a:\set{1,\ldots,d}^2\to C_s\cup \set{\bot}$,
with the following properties:
\begin{itemize}
	\item If $f_a(i,j)=b$ then the $i$th coordinate of $a$
	and the $j$th coordinate of $b$ are at distance at most $r$
	in $G-S$;
	\item If $f_a(i,j)=\bot$ then there is no element $b\in C_s$ 
	such that the $i$th coordinate of $a$ and the $j$th coordinate of $b$ are at distance at most $r$ in $G-S$.	
\end{itemize}
Observe that whenever $a_1, a_2$ are two distinct elements of $B-C_s$,
then for all $i,j\in \set{1,\ldots,d}^2$, the values $f_{a_1}(i,j)$ and $f_{a_2}(i,j)$
cannot be equal to the same element $b\in C_s$:
otherwise, we would have that the $i$th coordinate of $a_1$
and the $i$th coordinate of $a_2$ are at distance at most $2r$
in $G-S$, which is impossible by the assumption on $B$.

In particular, if $|B-C_s|> |C_s|\cdot d^2$
then there must be some element  $a\in B-C_s$  
such that $f_a(i,j)=\bot$  for all $i,j\in\set{1,\ldots,d}$.
Let $C_{s+1}=C_s\cup \set s$.
By construction, $C_{s+1}$ is totally $2r$-independent in $G-S$.

We may repeat the construction as long as $|B|>|C_s|\cdot (d^2-1)=s\cdot (d^2-1)$, and we stop when this inequality no longer holds. Define the set $C$ as the last constructed set $C_s$.
By construction, $|C_s|=s>
\frac{|B|}{d^2-1}>\frac{|B|}{d^2}$.	
\end{proof}

To finish the proof of Proposition~\ref{prop:uqw-tuples},
given a set $A\subset V(G)^d$ and numbers $r,m\in\N$,
first apply Lemma~\ref{lem:step1} 
  with $r'=2r$ and
 $m'= m\cdot d^2$.
 Assuming that $|A|\ge K(r',m')$, 
we obtain a set $B\subset A$ with $|B|\ge m\cdot d^2$ and a set $S\subset V(G)$ with $|S|\le s(2r)$.
To $B$ and $S$, apply Lemma~\ref{lem:step2}, yielding a set $C\subset B$ which is totally $r$-independent in $G-S$ and has size at least $m$. This yields the proposition, for $N^d(r,m)=K(r',m')$ and $s^d(r)=s(r')$.
\end{proof}


\subsection{Excluding long ladders}

\begin{lemma}
Let $\psi(\tup{x})$ be a formula and let $v_1,\ldots, v_m\in V(G)$. 
There is a formula $\vartheta(\tup{x})$ 
of the same quantifier rank as $\psi$ over a signature extended 
with $m$ colors such that for all $\tup{a}$ which do not
contain elements from $v_1,\ldots, v_m$ it holds that
$G\models\psi(\tup{a})\Leftrightarrow G\models\vartheta(\tup{a})$. 
\end{lemma}
\begin{proof}
As a preliminary step, we introduce $m$ constant symbols 
$c_1,\ldots, c_m$. We replace in $\psi$ all quantifiers 
$\exists x\xi(x,\tup{y})$ by $\exists x((x=c \wedge \xi^*(x,\tup{y})
\vee (x\neq c\wedge \xi^*(x,\tup{y}))$, 
where $\xi^*$ is the formula obtained by inductively continuing the
construction and similarly for the universal quantifier. Furthermore, 
we replace every atomic formula $E(c_i,c_j)$ by the truth value of
$E(v_i,v_j)$. Then we have
\[(G,v_1,\ldots, v_m)\models\psi^*(\tup{a})\Leftrightarrow G\models\psi(\tup{a}).\]
Obviously, the quantifier rank of $\psi^*$ is the same as that of $\psi$. 

We now build the formula $\psi^{**}$ as follows. We replace
every subformula $\exists x((x=c_i \wedge \xi^*(x,\tup{y}) \vee 
(x\neq c_i \wedge \xi^*(x,\tup{y}))$ by the formula
$\exists x(\xi^{***}(\tup{y}) \vee \xi^{**}(x,\tup{y}))$, 
where $\xi^{***}(\tup{y})$ is obtained from $\xi^{*}$ by
replacing every atom $E(c_i,y)$ by the atom $R_i(y)$. Here, 
$R_i$ is a new unary predicate which holds true exactly for 
the neighbors of $c_i$ in $G$. Note that $c_i$ occurs only together
with variables in atoms because we eliminated all other occurrences
before. Then we have 
\[G-\{v_1,\ldots, v_m\}\models \psi^{**}(\tup{a})
\Leftrightarrow (G,v_1,\ldots, v_m)\models\psi^*(\tup{a}).\]
We let $\vartheta(\tup{x})\coloneqq \psi^{**}(\tup{x})$ and conclude. 
\end{proof}

We can now translate $\vartheta(\tup{a})$ to Gaifman normal form. 
Note that the locality radius of the resulting formula does not depend
on the number $m$ of elements we delete. Only the number of local types
depends on this number, as the signature of the new formula is changed
depending on $m$. 

\begin{theorem}
Let $\psi(\tup{x})$ be a formula and let $v_1,\ldots, v_m\in V(G)$. 
There is an $r$-local formula $\vartheta(\tup{x})$ 
over a signature extended 
with $m$ colors such that for all $\tup{a}$ which do not
contain elements from $v_1,\ldots, v_m$ it holds that
$G\models\psi(\tup{a})\Leftrightarrow G\models\vartheta(\tup{a})$. 
Here, $r=2^{q+|\tup{x}|}$ by Gaifman's Theorem.
\end{theorem}

We now prove a tuple-wise uniform quasi-wideness, as Podewski and Ziegler 
prove in the infinite. For a set $S$ and two tuples $\tup{a},\tup{b}\in V(G)^k$
we write $\dist_{G-S}(\tup{a},\tup{b})>r$ if $\dist_{G-S}(x,y)>r$ for all $x,y\in 
(\tup{a}\cup\tup{b})\setminus S$. 

\begin{lemma}
For all $k,m,r\in \N$, there exist $M(k,m,r)\in \N$ and 
$s(k,m,r)\in \N$ such that if $A$ is a set of $k$-tuples
with $|A|>M$, then there exists a set $S\subseteq V(G)$
with $|S|\leq s$ such that $\dist_{G-S}(\tup{a},\tup{b})>r$
for all $\tup{a},\tup{b}\in A$. 
\end{lemma}
\begin{proof}

\end{proof}
