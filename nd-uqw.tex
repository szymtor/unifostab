\section{From nowhere denseness to uniform quasi-wideness}\label{sec:uqw}

This section is devoted to the proof of~\cref{thm:new-uqw}. 
Even though we prove a purely graph theoretic statement, 
it is useful to see our methods in a more general model-theoretic context. 


%\begin{definition}
%If $\tau$ is a word over an alphabet $\Sigma$ and
%$a\in \Sigma$, then $\tau\cdot a$ denotes the concatenation of~$\tau$
%and $a$.  The \emph{branching index} of a formula $\psi(\tup{x},\tup{y}$
%over a graph $G$ is the largest number
%$\ell$ such that there are tuples of elements
%$\tup{u}_{\sigma_1},\ldots, \tup{u}_{\sigma_{2^\ell}}\in V(G)$, indexed by the
%words over the alphabet $\{0,1\}$ of length exactly $\ell$, and
%tuples of elements $\tup{v}_{\tau_1},\ldots, \tup{v}_{\tau_{2^\ell-1}}$, indexed by the
%words over $\{0,1\}$ of length strictly smaller than $\ell$, such that
%if $\tau_j\cdot a$ is a (not necessarily proper) prefix of~$\sigma_i$, then
%$G\models \psi(\tup{u}_{\sigma_i},\tup{v}_{\tau_j})$ if, and only if, $a=1$. The tuples
%$\tup{u}_{\sigma_1},\ldots, \tup{u}_{\sigma_{2^\ell}}\in V(G)$ are called the 
%\emph{leaves} of the tree, the tuples $\tup{v}_{\tau_1},\ldots, \tup{v}_{\tau_{2^\ell-1}}$
%are its \emph{inner nodes}. Intuitively, a leaf $\tup{u}$ is connected to its 
%predecessors~$\tup{v}$ such
%that $\tup{u}$ is a \emph{right successor} of $\tup{v}$ and not to its predecessors such that 
%it is a \emph{left
%successor}. 
%\end{definition}
     

%\begin{lemma}[\cite{hodges1993model}, Lemma 6.7.9, p.\
%  313]\label{lem:branching}
%  Let $\psi(\tup{x},\tup{y})$ be a formula and let $G$ be a graph. 
%  If $\psi$ has branching index~$k$ over $G$, 
%  then~$\psi$ has ladder index smaller than $2^{k+1}$ over $G$. 
%  If $\psi$ has  has
%  ladder index $k$ over $G$, then $\psi$ has branching index smaller than
%  $2^{k+2}-2$ over $G$.
% \end{lemma}

In the proof of~\cref{thm:malshelah} one constructs a tree, in which
elements are iteratively classified according to their types. The depth of 
the type tree is directly related to the ladder index of the formula, 
more precisely to the \emph{branching index} of the formula. We refrain
from defining the branching index here and refer to~\cite{malliaris2014regularity}
and to Lemma 6.7.9 of the textbook \cite{hodges1993model}, which relates
ladder index and branching index. In this section we will be working with 
formula $\phi(x,y)$ with exactly two free variables only. 

Let $T$ be a binary tree, where each vertex (except the root) is 
marked as a left or right successor of its predecessor. We call $w$ 
a \emph{left (right) descendant} of $v$ if the first successor on the unique
$v$-$w$ path in $T$ is a left (right) successor. A root-leaf path in $T$ is called
$k$-alternating if it contains $k+1$ nodes $a_1,\ldots, a_{k+1}$ (which appear
in that order on the path, possibly not consecutively) such that $a_{i+1}$ is a left successor of $a_i$
if and only if $a_{i+2}$ is a right successor of $a_{i+1}$, $1\leq i\leq k-2$. 
The \emph{alternation rank} of $T$ is the largest number $t$ such that 
$T$ contains a $t$-alternating path of length $t$.

\begin{lemma}\label{lem:number-of-nodes}
Let $T$ be a tree of alternation rank $t$. If
$T$ has height at most~$h$, then $T$ has at most $(2h+2)^{t+1}$
vertices. 
\end{lemma}
\begin{proof}
Denote by $n_\ell^s$ the number of vertices a binary tree without a 
an $s$-alternating path can have. Then we have $n_0^s\leq 1$ for all $s\geq 1$
and $n_\ell^1\leq 2\ell-1$ for all $\ell$, and 
\begin{align*}
n_\ell^s\leq 2(n_{\ell-2}^{s-1}+n_{\ell-3}^{s-1}+\ldots + n_{0}^{s-1})+2\ell-1
\end{align*}
for all $s\geq 2,\ell\geq 1$. In the last inequality, we count the two paths of length
$\ell$ staring in the root which have no alternations. All nodes branching from 
these paths have one less alternation available. 
Now it is easy to check that the function $(2\ell+2)^s$ satisfies these requirements. 
\end{proof}

Let $\phi(x,y)$ be a formula with $2$ free variables and let $(v_1,\ldots, v_n)$
be a sequence of vertices of $G$. The \emph{type tree}
of $\phi$ over $(v_1,\ldots,v_n)$ is a binary tree which is constructed recursively as 
follows. We make $v_1$ the root of the tree. Assume that $v_1,\ldots, v_i$
have been inserted to the tree. We follow a root-leaf path to find the
position for the next vertex $v_{i+1}$. If $G\models\phi(v_j,v_{i+1})$, we
follow the right branch at $v_j$, otherwise we follow the left branch. If there is
no such successor, we insert $v_{i+1}$ as a right or left child of $v_j$, 
accordingly. 

\begin{lemma}
Let $\phi(x,y)$ be a formula with $2$ free variables and let
$(v_1,\ldots, v_n)$ be a sequence of elements of $G$. Then the 
alternation rank of the type tree of $\phi$ over $(v_1,\ldots, v_n)$
is at most twice the ladder index of $\phi$. 
\end{lemma}
\begin{proof}
An alternating path in $T$ is a $\phi$-ladder.
\end{proof}

We are now ready to prove~\cref{thm:new-uqw}. As in the 
original proof of Ne\v{s}et\v{r}il and Ossona de Mendez, the main 
idea is to find a few elements to delete such that a large
subset $A'\subseteq A$ is $2$-independent. We can then 
contract the disjoint neighborhoods of these elements and
continue with the depth-$1$ minor $G'$, where we 
identify $A'$ in $G$ with a set of vertices in $G'$. A $2$-independent
subset of $A'$ in $G'$ will be a $4$-independent set in $G$, 
and so on, until we finally arrive at an $r$-independent set. 

We can use Ramsey's Theorem to first find an independent subset
of $A$. 

\begin{lemma}\label{lem:ramsey1}
Let $G$ be a graph such that $K_t\not\subseteq G$. If $A$
has size at least $\binom{m+t-2}{t-1}$, then there exists
a subset $B\subseteq A$ of size at least $m$ which is an
independent set. 
\end{lemma}

We now consider the formula 
$\phi_2(x,y)\coloneqq \dist_G(x,y)\leq 2$, for which we can give an explicit 
bound on the alternation rank in its type tree. 

\begin{lemma}\label{thm:alternation-rank-type-tree}
Let $G$ be a graph such that $K_t\not\minor_2G$ and let
$(v_1,\ldots, v_n)$ be an enumeration of an independent set 
in $G$. Then the alternation rank of the type tree of $\phi_2$ 
over $(v_1,\ldots, v_n)$ is at most~$2t$. 
\end{lemma}
\begin{proof}
Assume that we find an alternating path $a_1,b_1,\ldots, a_k,b_k$ 
in the type tree, where $b_1$ is right of $a_1$. Otherwise, we consider
the path $b_1,a_2,b_2,\ldots,a_k, b_k$. Because $(v_1,\ldots, v_n)$ is independent in $G$, 
none of these vertices are adjacent and all of the vertices on the
paths of length $2$ which cause the creation of edges in the type
tree are distinct from $a_1,\ldots, b_k$. 

\begin{claim}
Every vertex $a_i$ is connected to every $b_j$, $j\geq i$,
via a vertex $z_{ij}$ which is not connected to any~$b_\ell$, $\ell\neq j$. 
\end{claim}

\noindent\textit{Proof.} Because $b_j$, $j\geq i$, is right of $a_i$, there is 
an element $z_{ij}$ connected to $a_i$ and $b_j$. If $z_{ij}$ was 
connected to $b_\ell$, $\ell\neq j$, then $b_\ell$ would be adjacent 
to $b_j$ in the type tree, which it is not. \hfill$\lrcorner$

\bigskip
Now let $X_j\coloneqq \{b_j\}\cup\{a_j\}\cup\{z_{ij} : 1\leq i\leq j\}$
for all $1\leq j\leq k$. $X_j$ is connected and has radius $2$. As $a_i$
is connected to $z_{ij}$ and $a_i\in X_i$ and $z_{ij}\in X_j$ for $i\neq j$, 
we have constructed a complete graph $K_k$ as depth-$2$ minor. Hence 
$k\leq t-1$, which proves the claim. 
\end{proof}

Note that the above proof does not give a proof that the ladder
index of the distance-$2$ formula is at most $2(t-1)$. In the type
tree we have the stronger statement that the vertices $b_i$
are not connected by a path of length $2$. 
We make no statement about the connections
of these elements in the ladder. 

We need more lemma, which is based on the fact that
nowhere dense classes of graphs do not have dense 
shallow minors~\cite{dvorak2007asymptotical,jiang2011compact}. 

\begin{lemma}[adaptation of Lemma 4.11 in \cite{gajarsky2017kernelization}]\label{lem:diversity}\label{lem:gajarsky}
Let $\CCC$ be a nowhere dense class of graphs. Let $G\in \CCC$ and let $A\subseteq V(G)$. 
Then for every $\epsilon>0$ there exists $n_0$ such that if $|A|\geq n_0$, then 
\[\abs{\{N(v)\cap A : v\in V(G)\}}\leq\abs{A}^{1+\epsilon}.\]
\end{lemma}

The following lemma is the main building block of our proof. 

\begin{lemma}\label{lem:apex}
Let $\CCC$ be a nowhere dense class of graphs. 
Let $n_0$ be the constant of for $\epsilon=1/3$. 
Assume $K_t\not\minor_2 G$. 
Let $m\geq n_0$ be an integer. 
Let $A$ be an independent set in $G$ of size at least $(4(m+1)^3+2)^{2t+1}$. 
Then either $A$ contains a $2$-independent set of size $m$ or
there is a subset $A'\subseteq A$ of size at least~$m$ and
a vertex $v\in V(G)$ which is adjacent to all vertices of $A'$. 
\end{lemma}
\begin{proof}
Fix any enumeration $v_1,\ldots$ of $A$ and
build the type tree $T$ of the formula $\dist(x,y)\leq 2$ over
$v_1,\ldots$. According to~\cref{thm:alternation-rank-type-tree}, 
the alternation rank of $T$ is at most~$2t$. 

According 
to~\cref{lem:number-of-nodes}, $T$ has depth at least $2(m+1)^3$, hence, 
it contains a path of length at least $2(m+1)^3$. We choose the largest set $X$
of vertices on that path without alternations, which has hence length
at least $(m+1)^3$. 

Either, $X$ is a set with all its successors in $T$ on the left, 
then $X$ is a $2$-independent set and we let $A'=X$ and finish the proof.

Otherwise, all vertices of $X$ are at distance $2$. Let $\ell+1=|X|$. 
We claim that we find an element which is connected to at least $\ell^{1/3}$
of the vertices of $X$. There are $\binom{\ell+1}{2}\geq \ell^2/2$ pairs in $X$ which 
must be connected via an intermediate vertex. A vertex of degree
$d$ can create $\binom{d}{2}\leq d^2/2$ of such connections. 
Hence, if there is no vertex which is connected to at least $\ell^{1/3}$
vertices of $A$, we need $\ell^{4/3}$ vertices with distinct neighborhoods
to create all connections. As $\ell\geq n_0(1/3)$, 
this contradicts \cref{lem:gajarsky}. Hence there exists a vertex $v$ which is 
adjacent to at least $m$ vertices of $A$, we let $A'=N(v)\cap A$ and finish 
the proof. 
\end{proof}

We iteratively apply \cref{lem:apex}, always adding the apex vertex 
returned by the lemma to the set $S$, until we find a large 
$2$-independent subset of $A$ in $G-S$. For the induction, we
define a function $R$ such that $R(m,1)=(4(m+1)^3+2)^{2t+1}$
and $R(m, i+1)=(4(R(m,i)+1)^3+2)^{2t+1}$.

\begin{lemma}\label{lem:iterate-apex}
Let $\CCC$ be a nowhere dense class of graphs. 
Let $n_0$ be the constant of for $\epsilon=1/3$. 
Assume $K_t\not\minor_2 G$. 
Let $m\geq n_0$ be an integer. 
Let $A$ be an independent set in $G$ of size at least $R(m,t)$. 
Then there is a subset $A'\subseteq A$ of size at least~$m$ and a 
a set $S\subseteq V(G)\setminus A$ of size at most $t-1$ such that
\begin{enumerate}
\item every vertex of $S$ is connected to every vertex of $A'$, and
\item $A'$ is $2$-independent in $G-S$. 
\end{enumerate} 
\end{lemma}
\begin{proof}
Apply \cref{lem:apex} inductively. In step $i$ of the induction,
either the lemma returns a $2$-independent $A'$ or a vertex $v$
which is adjacent to $A'=N(v)$ of size $R(m,t-i)$. In the second
case, add the vertex $v$ to $S$. After $t-1$
iterations we must be in the first case, as otherwise we have found a 
complete bipartite graph $K_{t,t}$ as a subgraph of $G$. 
This graph contains $K_t$ as a depth-$1$ minor, contradicting
our assumption. 
\end{proof}

We now proceed by induction on $r$. 

\begin{lemma}\label{lem:ramsey2}
Let $G$ be a graph such that $K_t\not\minor_r G$. 
If $A$ is $2r$-independent and
has size at least $\binom{m+t-2}{t-1}$, then there exists
a subset $B\subseteq A$ of size at least $m$ which is a
$(2r+1)$-independent set. 
\end{lemma}
\begin{proof}
As $A$ is $2r$-independent, we can contract the $r$-neighborhood
of each $v\in A$. The corresponding elements $N_r[v]$ in the resulting 
depth-$r$ minor $H$ form a set $Z$ that is in \mbox{$1$-to-$1$} correspondence 
with $A$. By assumption, 
$H[Z]$ excludes $K_t$ as a subgraph, and hence by \cref{lem:ramsey1},
it contains an independent set $B'\subseteq Z$ of size $m$ in $H$. 
This set $B'$ corresponds to a $(2r+1)$-independent set $B\subseteq A$ of $G$. 
\end{proof}

\begin{lemma}\label{lem:distance-apex}
Let $\CCC$ be a nowhere dense class of graphs. 
Let $n_0$ be the constant of for $\epsilon=1/3$. 
Assume $K_t\not\minor_{r+2} G$. 
Let $m\geq n_0$ be an integer. 
Let $A$ be a $(2r+1)$-independent set in $G$ of size at least $R(m,t)$. 
Then there is a subset $A'\subseteq A$ of size at least~$m$ and a 
a set $S\subseteq V(G)\setminus A$ of size at most $t-1$ such that
\begin{enumerate}
\item every vertex of $S$ is connected to a vertex at distance $r$ of $w$ for 
every $w\in A'$, and
\item $A'$ is $(2r+2)$-independent in $G-S$. 
\end{enumerate} 
\end{lemma}
\begin{proof}
As $A$ is $(2r+1)$-independent, we can contract the $r$-neighborhood
of each $v\in A$. The corresponding elements $N_r[v]$ in the resulting 
depth-$r$ minor $H$ form a set $Z$ that is in $1$-to-$1$ correspondence 
with $A$. As $A$
is $(2r+1)$-independent, $Z$ is independent in $H$. We now apply 
\cref{lem:iterate-apex} to $Z$ in $H$. Note that the depth-$2$ minor
we construct in \cref{thm:alternation-rank-type-tree} (now applied to $H$) 
uses as connecting vertices $z_{ij}$ original vertices of the graph and
not contracted vertices. Hence, when we apply the lemma, we may 
use the assumption that $K_t\not\minor_{r+2} G$ (in general, 
a depth-$2$ minor of a depth-$r$ minor may be a depth-$5r$ minor
of the original graph~see Proposition~4.1 of~\cite{sparsity}). 
Also, the vertices $v$ returned by 
\cref{lem:iterate-apex} correspond to vertices of the graph $G$ and not
to contracted neighborhoods. In particular, as $A$ is $(2r+1)$-independent, 
the vertices $v$ returned by the lemma have distance exactly $r$ to 
the vertices $w\in A$. The set $Z'$ returned by \cref{lem:iterate-apex}
for $H$ is $2$-independent in $H$, and hence the corresponding 
subset $B\subseteq A$ of $G$ is $(2r+2)$-independent. 
in $G$. 
\end{proof}

After iterating \cref{lem:ramsey2} and \cref{lem:distance-apex} 
alternatingly
for $r$ times, we have found the desired $r$-independent set. Note
that throughout the process we delete a set $S$ of size at most
$t-1$, if $K_t\not\minor_{r+1} G$. This proves \cref{thm:new-uqw}. 