\section{From nowhere denseness to uniform quasi-wideness}\label{sec:uqw}

This section is devoted to the proof of \cref{thm:new-uqw}. 
In the presentation we focus on proving the existential statement, and at the end we briefly argue how the proof can be turned into an algorithm with the promised running time guarantee.
We first recall necessary preliminaries from graph theory. 

\paragraph*{Preliminaries.}
All graphs in this paper are finite, undirected and simple, that is, 
they do not have loops or parallel edges. Our notation is standard,
we refer to~\cite{diestel2012graph} for more background on 
graph theory. 
We write $V(G)$ for the vertex set of a graph $G$ and
$E(G)$ for its edge set. 
The {\em{distance}} between vertices $u$ and $v$ in $G$, denoted $\dist_G(u,v)$, is the length of a shortest path between $u$ and $v$ in~$G$.
If there is no path between $u$ and $v$ in $G$, we put $\dist_G(u,v)=\infty$.
For a vertex $u$ and nonnegative integer $s$, by $N_s[u]$ we denote the {\em{$s$-neighborhood of $u$}} which comprises vertices at distance at most $s$ from $u$.

A {\em{minor model}} of a graph $H$ in $G$ is a family $(I_u)_{u\in V(H)}$ of pairwise vertex-disjoint connected subgraphs of $G$, called {\em{branch sets}},
such that whenever $uv$ is an edge in~$H$, there are $u'\in I_u$ and $v'\in I_v$ for which $u'v'$ 
is an edge in $G$.
The graph $H$ is a {\em{depth-$r$ minor}} of $G$, denoted $H\minor_rG$, if there is a minor model
$(I_u)_{u\in V(H)}$ of~$H$ in $G$ such that each $I_u$ has radius at most $r$.

A class $\CCC$ of graphs is \emph{nowhere dense} if there is a function 
$t\colon \N\rightarrow \N$ such that for all $r\in \N$ it holds that $K_{t(r)}\not\minor_r G$
for all $G\in \CCC$. 

A set $B\subseteq V(G)$ is called {\em{$r$-independent}} in a graph $G$ if for all
distinct $u,v\in B$ we have $\dist_G(u,v)>r$.
A class $\CCC$ of graphs is \emph{uniformly quasi-wide} if there are
functions $N\colon \N\times\N\rightarrow \N$ and $s:\N\rightarrow \N$ such
that for all $r,m\in \N$, all graphs $G\in \CCC$, and all subsets $A\subseteq V(G)$ of size $\abs{A}\geq N(r,m)$, there is a set
$S\subseteq V(G)$ of size $\abs{S}\leq s(r)$ and a set
$B\subseteq A\setminus S$ of size $\abs{B}\geq m$ which is $r$-independent in
$G-S$. 

\paragraph{General strategy.}
Our proof follows exactly the same lines as the original proof of Ne\v set\v ril and Ossona de Mendez, with the difference that in one technical lemma (\cref{lem:apex} below), we improve the bounds significantly by replacing a Ramsey argument by bounds on neighborhood
complexity in nowhere dense graph classes, due to~\cite{gajarsky2017kernelization}.
For sake of completeness, we present the entire proof of~\cref{thm:new-uqw}.


The general idea behind the proof of 
\cref{thm:new-uqw} is to prove the following 
weaker variant, for each radius $r$:

\begin{lemma}\label{lem:engine}
For all $r,t\in \N$ there exists a function $L\colon \N\to \N$
and a number $d$ such that the following holds.
Given a number $m\in \N$ and graph $G$ such that $K_t\not\minor_d G$ and
$(r-1)$-independent set of vertices $A\subset V(G)$ of size at least $L(m)$ there is a set $S\subseteq V(G)$ of size at most $t$ such that $A-S$ contains a subset of size $m$ which is $r$-independent in $G-S$.
\end{lemma}

Note that the main difference between the statement of this lemma and~\cref{thm:new-uqw} is that here we assume that 
$A$ is already $(r-1)$-independent, whereas in~\cref{thm:new-uqw} we make no assumptions on $A$. However, the theorem then follows by an easy induction: to find an $r$-independent set in a set $A$, we start with 
the very large ($0$-independent) set $A_0=A$, in which (after removing 
$L(1)$ vertices from $G$)
we find a very large $1$-independent subset $A_1$, in which (after further removing $L(2)$ vertices from $G$) we find a large $2$-independent subset $A_2$, etc., until arriving at an $r$-independent subset $A_r$ of size $m$.

To prove~\cref{lem:engine}, we distinguish two special cases: the case of $r=0$ and the case $r=1$. The case of general $r$ then reduces to one of these two cases, depending on the parity of $r$, by observing that a $(2s+1)$-independent set $A$ in $G$
induces a $1$-independent set in $G$ with the balls of radius $s$ around the vertices of $A$ contracted, and,
similarly, a $(2s+2)$-independent set $A$ in $G$
induces a $2$-independent set in $G$ with the balls of radius $s$ around the vertices of $A$ contracted.

We start by proving~\cref{lem:engine} in the case $r=0$,
then we prove it in the case $r=1$. Next we show how the general case reduces to one of those two, and, finally, we deduce~\cref{thm:new-uqw} from~\cref{lem:engine}.

\paragraph{Case $r=1$.}
We prove~\cref{lem:engine} in the case $r=1$.
Let $d=0$, so $K_t\not\minor_d G$ amounts to saying that $G$
does not contain a clique of size $t$. By Ramsey's Theorem, in any graph every set of size $\binom{m+t-2}{t-1}$ contains an
independent set of size $m$ or a clique of size $t$. Therefore, 
taking $L(m)$ as the above binomial coefficient yields~\cref{lem:engine} in case $r=0$, by taking $S=\emptyset$.

\paragraph{Case $r=2$.}
We prove~\cref{lem:engine} in the case $r=2$.
For the second, more intricate case, 
we employ one more result: the bound on the number of distinct neighborhoods in a graph from a nowhere dense class.

\begin{lemma}[adaptation of Lemma 4.11 in \cite{gajarsky2017kernelization}]\label{lem:diversity}
Let $G$ be a graph such that $K_t\not\minor_{1} G$ for some constant $t\in \N$. 
Then for every $\epsilon>0$ there exists $n_0$, depending only on $t$ and $\epsilon$, such that for all $A\subseteq V(G)$ with $|A|\geq n_0$ it holds that
\[\abs{\{N(v)\cap A \colon v\in V(G)\}}\leq\abs{A}^{1+\epsilon}.\]
\end{lemma}



We remark that the proof of \cref{lem:diversity} uses only the fact that
nowhere dense classes of graphs do not have dense 
shallow minors~\cite{dvorak2007asymptotical,jiang2011compact}, and does not rely on any non-constructive arguments from the stability theory.
From \cref{lem:diversity} we derive the following.

\begin{corollary}\label{cor:diversity}
  Let $G,t,\epsilon,n_0$ be as above.
  If $|A|=n\ge n_0$ and every pair of elements of $A$ has a common neighbor in $G$,
  then there is a vertex $v$ in $G$ which has at least $n^{(1-\epsilon)/2}$ neighbors in $A$.
\end{corollary}
\begin{proof}Let ${\cal F}=\set{N(v)\cap A\colon v\in V(G)}$. 
  Suppose that every set in ${\cal F}$ has at most $k$ elements. 
  Say that a pair $(a,b)$ of elements of $A$ is \emph{covered} by $F\in {\cal F}$
  if  $a,b\in F$.
  By assumption, all $n^2$ pairs in $A^2$ are covered by some element $F\in {\cal F}$, and,
  clearly, every $F\in {\cal F}$ can cover at most $k^2$ pairs. 
  Hence, $n^2/k^2\le |{\cal F}|\le  n^{1+\epsilon}$, proving $k\ge n^{(1-\epsilon)/2}$.
\end{proof}

\begin{corollary}\label{cor:biversity}
    For every real $\alpha>2$ and integer $t\in\N$ there exists $\ell_0$ with the following property.
  Let $G$ be a graph which does not contain 
  the complete bipartite graph $K_{t,t}$ and let
  $A$ be a $1$-independent subset of $G$ with $|A|\ge \ell_0$ such that every pair of vertices in $A$ has a common neighbor in $G$.
   Then there is a vertex $v\in G$
  with at least $|A|^{1/\alpha}$ neighbors in $A$.
\end{corollary}
\begin{proof}\label{pf:}
    Note that if $K_{2t}$ has a depth $1$ minor model in 
    a bipartite graph $H$, then there is a depth $1$ minor model of $K_{t}$ in $H$ with all centers of branch sets contained in one part of $H$. This, in turns, implies that $K_{t,t}$ is a subgraph of $H$.
  Choose $H$ to be the bipartite graph induced 
  by $G$, with parts $A$ and $V(G)-A$, i.e.,  $v\in A$ and $w\in V(G)-A$ are adjacent in $H$ iff they are in $G$. Since $G$ does not contain the complete bipartite graph $K_{t,t}$, neither does $H$. By the preceding remark, this implies  that $K_{2t}\not\minor_1 H$.
  Let $\ell_0$
    be the value $n_0$ from~\cref{lem:diversity} applied to $2t$ in place of $t$ and $\epsilon$ such that $2/(1-\epsilon)=\alpha$. Applying~\cref{cor:diversity} to $H,2t,\epsilon,\ell_0$, we conclude that if every pair of elements of $A$ has a common neighbor in $G$
    (hence also in $H$), then there is a vertex $v$
    in $G$ with at least $|A|^{1/\alpha}$ neighbors in $A$.
\end{proof}

% \begin{corollary}\label{lem:gajarsky}
% Let $G$ be a graph, let $s\in \N$, and suppose there is a constant $t\in \N$ such that $K_t\not\minor_{3s+1} G$.
% Then for every $\epsilon>0$ there exists $n_0$, depending only on $\epsilon,t,s$, such that for each vertex subset $A\subseteq V(G)$ that is $(2s+1)$-independent in $G$ and satisfies $|A|\geq n_0$, it holds that
% \[\abs{\{N_{s+1}[v]\cap A \colon v\in V(G)\}}\leq\abs{A}^{1+\epsilon}.\]
% \end{corollary}
% \begin{proof}
% As $A$ is $(2s+1)$-independent, we have that the $s$-neighborhoods of vertices from $A$ are pairwise disjoint.
% Obtain an $s$-shallow minor $H$ of $G$ by contracting $N_s[u]$ for each $u\in A$.
% We implicitly identify each vertex $u\in A$ with the vertex of $H$ obtained from contracting $N_s[u]$, thus $A\subseteq V(H)$.
% It is known that every $1$-shallow minor of $H$ is also a $(3s+1)$-shallow minor of $G$ (cf.~\cite[Proposition~4.1]{sparsity}), hence $K_t\not\minor_{1} H$.
%
% Let us fix $\epsilon>0$.
% Take any $v\in V(G)$. If $v\in N_s[u]$ for some $u\in A$, then since $A$ is $(2s+1)$-independent, we have that $v$ is at distance larger than $2s+1$ from any other vertex of $A$.
% Hence in this case we have $N_{s+1}[v]\cap A=\{u\}$ and there can be at most $|A|$ neighborhoods of this type.
% Next, suppose $v\notin N_s[u]$ for any $u\in A$. Then by the construction of $H$ we have that $N_{s+1}[v]\cap A=N^H[v]\cap A$, where $N^H[v]$ is the neighborhood of $v$ in $H$.
% Since $K_t\not\minor_{1} H$, by \cref{lem:diversity} we have that the number of such neighborhoods is at most $|A|^{1+\epsilon/2}$,
% provided $|A|\geq n_0$ for some $n_0$ depending only on $t$ and $\varepsilon$.
% Thus, we conclude that $\abs{\{N_{s+1}[v]\cap A \colon v\in V(G)\}}\leq |A|+|A|^{1+\epsilon/2}$, which is bounded by $|A|^{1+\epsilon}$ if we choose $n_0$ large enough.
% \end{proof}
%
% %Observe that nowhere dense classes are closed under
% %taking bounded depth minors, as stated in the following lemma.
% %It is an immediate consequence of Proposition~4.1
% %of~\cite{sparsity}.
%
% %\begin{lemma}
% %Let $\CCC$ be a nowhere dense class of graphs and let $s\in \N$.
% %Then also the class $\{H \minor_s G \colon G\in \CCC\}$ is nowhere dense.
% %\end{lemma}



We  now state the main building block of our proof as a lemma. 

\begin{lemma}\label{lem:apex}
For every integer $t\in \N$ and real $\alpha>2$ 
there is an integer $\ell_0\in\N$ with the following property.
Let $m,\ell$ be integers with $\ell\ge \ell_0$. 
If~$G$ is a graph and $A$ is its $1$-independent subset
with at least $(m+\ell)^{t}$ elements,
then at least one of the following conditions hold:
\begin{enumerate}
  % \item $A$ contains the principal vertices of a $1$-subdivision of a clique $K_t$ contained in $G$,
  \item $K_t\minor_{2} G$,
\item  $A$ contains a $2$-independent set of size $m$, 
\item  some vertex $v$ of $G$
has at least $\ell^{1/\alpha}$ neighbors in $A$.
\end{enumerate}
\end{lemma}


To prove the lemma, we will arrange the elements of $A$ in a binary tree
and prove that the tree contains a long path. From this path, we will 
extract the set $A'$. In stability theory, similar trees are called \emph{type trees} and they are used to extract long indiscernible sequences, see e.g.~\cite{malliaris2014regularity}. 

\begin{proof}
	\newcommand{\dau}{D}
	\newcommand{\son}{S}
	
	We identify words  $\set{\dau,\son}^*$ with \emph{nodes}
	of the infinite rooted binary tree. For $w\in \set{\dau,\son}^*$,
	 the nodes $w\dau$ and $w\son$ are called, respectively, the \emph{daughter} and the \emph{son} of $w$,
	and $w$ is the \emph{father} of both $w\son$ and $w\dau$.
	We consider
	 finite, labeled, rooted, binary trees, which are called simply trees below, and are defined as follows.
	 A \emph{tree} is a partial labeling $\tau\from \set{\dau,\son}^*\to U$ whose domain is a finite set of nodes, called the \emph{nodes of $\tau$}, which is closed under taking fathers.
  
  Let $G$ be a graph, $A\subset V(G)$ a $1$-independent set of its vertices
  and $\bar a$ an enumeration of $A$.
We define  a binary tree $\tau$ which is 
  labeled by vertices of $G$. The tree is defined by processing all elements of the sequence $\bar a$ sequentially. We start with $\tau$ being the  tree with empty domain, and for each element $a$ of the sequence $\bar a$, execute the following procedure, which extends the domain of $\tau$ by one element.
  
When processing the vertex $a$, do the following. Start with $w$ being the empty word. While $w$ is in the domain of $\tau$, repeat the following step: 
  if the distance from $a$ to $\tau(w)$ in the graph 
  $G$ is two, replace $w$ by its son, otherwise, replace $w$ by its daughter.
  % Repeat the step, unless $\tau(w)$ is undefined.
  Once $w$ is not in the domain of $\tau$, extend $\tau$ to $w$    so that  $\tau(w)=a$. In this way, we have processed the element $a$, and now
    proceed to the next element $a$ of $\bar a$, until all elements are processed. This ends the construction of $\tau$.
	
  
  
  
  \medskip
For a tree $\tau$, define its
\emph{height} as 
the length of the longest word in the domain of $\tau$.
For a word $w$, define an \emph{alternation} to be 
a position $i$ such that $w_i\neq w_{i-1}$, where $w_0$ is assumed to be $\dau$.
 The \emph{alternation rank} of the tree $\tau$ is the maximum of the number of alternations of $w$, over all nodes $w$ of $\tau$.


\begin{lemma}\label{lem:number-of-nodes}
Let $h,t\ge 2$.	If $\tau$ has alternation rank at most $t-1$ and height at most $h-1$, then $\tau$ has fewer than $h^{t}$
	nodes.
\end{lemma}
\begin{proof}		
	To each node $w$ of $\tau$ assign 
	the function $f_w:\set{1,\ldots,t}\to\set{1,\ldots,h}$ which
	maps a number $i$ to the $i$th smallest index $j\ge 1$
	such that $w_j\neq w_{j-1}$, if it exists, 
	where $w_0$ is assumed to be equal $\dau$,
	and if such an index $j$ does not exist, then $f_w(i)=|w|+1$.
		The mapping $w\mapsto f_w$ is injective
and its image is contained in monotone functions, hence the domain of $\tau$ 
		has fewer than $h^{t}$ elements.
\end{proof}

\begin{lemma}\label{thm:alternation-rank-type-tree}
Suppose that  $K_t\not\minor_{2} G$.
Then $\tau$ has alternation rank at most $2t-1$.
\end{lemma}
\begin{proof}
	Let $w$ be a node of $\tau$ with alternation rank at least $2k$.  
	In particular, there are nodes $a_1,b_1,\ldots,a_k,b_k$ in $A$
	such that for each $i=1,\ldots,k$, 
	the nodes in $\tau$ corresponding to $b_i,a_{i+1},b_{i+1},\ldots,a_k,b_k$ are  descendants of the son of the node which corresponds to $a_i$,
	and the nodes corresponding to $a_{i+1},b_{i+1},\ldots,a_k,b_k$
	are descendants of the daughter of the node which corresponds to $b_i$.
	
	\begin{claim}
		For every pair $a_i,b_j$ with $1\le i\le j\le k$, there is a vertex $z_{ij}$
		which is a common neighbor of $a_i$ and $b_j$,
		and is not a neighbor of $b_s$, for $s\neq j$.
	\end{claim}
	\begin{proof}
		Note that if $i\le j$, then $d(a_i,b_j)\le 2$, however, $d(a_i,b_j)>1$ since $A$
		is independent. In particular, there is a vertex $z_{ij}$ which is a common neighbor of $a_i$ and $b_j$. 
		Suppose that $z_{ij}$ is a neighbor of $b_s$, for some $s\neq j$. This implies that $d(b_j,b_s)\le 2$, which is impossible, 
since
		 the nodes corresponding to $b_s$ and $b_j$ in $\tau$ are such that one is a descendant of the daughter of the other, implying that $d(b_s,b_j)>2$.
	\end{proof}
  


For each $j=1,\ldots,k$, define the graph $B_j$
as the subgraph of $G$ induced by the set
$\set{a_j,b_j}\cup\set{z_{ij}\mid 1\le i\le  j}$.
By the claim above we have that the graphs $B_j$
are pairwise disjoint, for $j=1,\ldots,k$.
Moreover, for $1\le i\le j\le k$, there is an edge between $B_i$
and $B_j$, namely, the edge between $z_{ij}\in B_j$
and $a_i\in B_i$.
Hence, the graphs $B_j$, for $1\le j\le l$, define a depth-$(2s+2)$ minor model of $K_k$ in $G$. Since $K_t\not\minor_{2}G$, this implies that $k<t$, proving~\cref{thm:alternation-rank-type-tree}.
\end{proof}

To prove~\cref{lem:apex}, let $\ell_0$
be the number obtained from~\cref{cor:biversity}.
Fix integers $\ell\ge \ell_0$ and $m$, and define $h=m+\ell$.
Let $A$ be an independent subset of $G$
of size at least $h^{t}$.

Suppose that the first case of~\cref{lem:apex} does not hold. In particular $K_t\not\minor_2 G$, so by~\cref{thm:alternation-rank-type-tree}, $\tau$ has alternation rank at most $2t-1$. From~\cref{lem:number-of-nodes} 
we conclude that $\tau$  has height at least~$h$.
As $h=m+\ell$, it follows that either $\tau$  has a node $w$ which contains at least $m$ letters $\dau$, or $\tau$ has a node which contains  at least $\ell$ letters $\son$.

Consider the first case, i.e., there is a node $w$ of $\tau$
which contains at least $m$ letters $\dau$, and let $X$
be the set of all nodes $\tau(v)$ such that $v\dau$ is a prefix of $w$. Then, by construction, $X$ is a $2$-independent subset of $G$ of size at least $m$, so the second case of the lemma holds.

Finally, consider the second case, i.e., there is anode $w$ in $\tau$ which contains at least $\ell$ letters $\son$, and let 
$Y$ be the set of all nodes $\tau(v)$ such that $v\son$ is a prefix of $w$. Then, by construction, $Y\subset A$ is a set of vertices which are mutually at distance exactly $2$ in $G$. By~\cref{cor:biversity}, there is a vertex $v\in G$
with at least $\ell^{1/\alpha}$ neighbors in $Y$.
\end{proof}



We now prove~\cref{lem:engine} in the case $r=2$, and for $d=2$, i.e., we assume that $A$ is a sufficiently large subset of a graph $G$ such that $K_t\not\minor_2 G$.
Our goal is to exhibit a large $2$-independent subset 
of a large $1$-independent subset of  $G-S$, where $S$ is a small set. 
To this end, we iteratively apply \cref{lem:apex} as long as  it results in the third case, yielding a vertex $v$ with many neighbhors in $A$. In this case, we add $v$ vertex to the set $S$, and apply the lemma again,
restricting $A$ to $A\cap N(v)$. 
The precise calculations follow.

Let $G,t$ be as above, and fix some number $\alpha>2$. Let $\ell_0$ be the number granted by~\cref{lem:apex}, and denote $\beta= 2m\alpha$.
We will apply the lemma in the form of the following implication~($\ast$):
for $G$ and $A$  as above, if $A$ does not contain a $2$-independent set of size $m$ and $|A|\ge (2\ell_0)^m$, then there is a vertex $v$ of $G$ which has
at least $|A|^{1/\beta}$ neighbors in $A$.


Suppose that $|A|\ge t^{\beta^t}$ and $|A|\ge (2\ell_0)^{m\cdot \beta^t}$.
We construct a sequence  $A=A_0\supseteq A_1\supseteq\ldots$ 
of $1$-independent subsets of $G$
of length at most $m$,
such that $|A_i|\ge |A_0|^{1/\beta^i}$,
 as follows. Start with $S=\emptyset$, $A_0=A$, and 
for $i=1,2,\ldots$,
 apply~$(\ast)$ to the graph $G-S$ playing the role of $G$, 
 $A_{i-1}$ playing the role of $A$.
The assumptions are satisfied, since $$|A_{i-1}|\ge 
|A_0|^{1/\beta^i}\ge |A_0|^{1/\beta^t}\ge (2\ell_0)^m.$$
If $A_{i-1}$ contains a $2$-independent set of size $m$ in $G-S$, terminate.
 Otherwise, there is a vertex $v_i$ of $G-S$
 whose neighborhood in $G-S$ contains at least
 $|A_{i-1}|^{1/\beta}$ elements of $A_{i-1}$.
 Let $A_{i}$ consist of those elements, and add $v_i$
 to the set $S$, and proceed by replacing $i$ by $i+1$.
 
 Note that by construction, the vertex $v_i$ is connected in $G$
 to all vertices of $A_{i}$. In particular, all the vertices $v_1,\ldots,v_i$ are connected to all the vertices of $A_{i}$
 and $|A_i|\ge |A_0|^{1/\beta^i}\ge |A_0|^{1/\beta^t}\ge t$. In particular, as $G$
 does not contain the $1$-subdivision of $K_t$,
 the process must terminate with $i<t$.
 Hence, at some point we must have obtained a $2$-independent subset of $G-S$ of size $m$.
 Moreover, $|S|\le t$.


\paragraph{General case}
We now prove~\cref{lem:engine} in the general case.
Suppose that $r=2s+i$, where $i$ is $1$ or $2$, and $s\in\N$. Let $A$ be an $(r-1)$-independent subset of a graph $G$. Consider the graph $G'$ obtained from $G$
by contracting the $s$-neighborhood around each vertex $v\in A$. Identifying each vertex $v\in A$ with the resulting contracted ball in $G'$,  $A$ induces an $(i-1)$-independent subset in $G'$. 
Taking $d=r-1$, the assumption $K_t\not\minor_d G$
implies that $A$ does not contain the principle vertices of a $1$-subdivision of $K_t$, and so we may apply the already proved case to $G'$, yielding a subset $B$ of $A$ and a subset $S$ of $G'-A$
so that $B$ is $i$-independent in $G'-S$. 
This corresponds to a subset $B$ of $A$ and a subset $S$ of $G$
so that $B$ is $r$-independent in $G-S$.
This finishes  the proof of the general case of~\cref{lem:engine}.



\paragraph*{Finishing the proof of \cref{thm:new-uqw}.}
We now wrap up the proof of \cref{thm:new-uqw} by applying induction on the radius. 

%\begin{lemma}\label{lem:ramsey2}
%Let $G$ be a graph such that $K_t\not\minor_r G$. 
%If $A$ is $2r$-independent and
%has size at least $\binom{m+t-2}{t-1}$, then there exists
%a subset $B\subseteq A$ of size at least $m$ which is a
%$(2r+1)$-independent set. 
%\end{lemma}
%\begin{proof}
%As $A$ is $2r$-independent, we can contract the $r$-neighborhood
%of each $v\in A$. The corresponding elements $N_r[v]$ in the resulting 
%depth-$r$ minor $H$ form a set $Z$ that is in \mbox{$1$-to-$1$} correspondence 
%with $A$. By assumption, 
%$H[Z]$ excludes $K_t$ as a subgraph, and hence by \cref{lem:ramsey1},
%it contains an independent set $B'\subseteq Z$ of size $m$ in $H$. 
%This set $B'$ corresponds to a $(2r+1)$-independent set $B\subseteq A$ of $G$. 
%\end{proof}
%
%\begin{lemma}\label{lem:distance-apex}
%Let $\CCC$ be a nowhere dense class of graphs. 
%Let $n_0$ be the constant of for $\epsilon=1/3$. 
%Assume $K_t\not\minor_{r+2} G$. 
%Let $m\geq n_0$ be an integer. 
%Let $A$ be a $(2r+1)$-independent set in $G$ of size at least $R(m,t)$. 
%Then there is a subset $A'\subseteq A$ of size at least~$m$ and a 
%a set $S\subseteq V(G)\setminus A$ of size at most $t-1$ such that
%\begin{enumerate}
%\item every vertex of $S$ is connected to a vertex at distance $r$ of $w$ for 
%every $w\in A'$, and
%\item $A'$ is $(2r+2)$-independent in $G-S$. 
%\end{enumerate} 
%\end{lemma}
%\begin{proof}
%As $A$ is $(2r+1)$-independent, we can contract the $r$-neighborhood
%of each $v\in A$. The corresponding elements $N_r[v]$ in the resulting 
%depth-$r$ minor $H$ form a set $Z$ that is in $1$-to-$1$ correspondence 
%with $A$. As $A$
%is $(2r+1)$-independent, $Z$ is independent in $H$. We now apply 
%\cref{lem:iterate-apex} to $Z$ in $H$. Note that the depth-$2$ minor
%we construct in \cref{thm:alternation-rank-type-tree} (now applied to $H$) 
%uses as connecting vertices $z_{ij}$ original vertices of the graph and
%not contracted vertices. Hence, when we apply the lemma, we may 
%use the assumption that $K_t\not\minor_{r+2} G$ (in general, 
%a depth-$2$ minor of a depth-$r$ minor may be a depth-$5r$ minor
%of the original graph~see Proposition~4.1 of~\cite{sparsity}). 
%Also, the vertices $v$ returned by 
%\cref{lem:iterate-apex} correspond to vertices of the graph $G$ and not
%to contracted neighborhoods. In particular, as $A$ is $(2r+1)$-independent, 
%the vertices $v$ returned by the lemma have distance exactly $r$ to 
%the vertices $w\in A$. The set $Z'$ returned by \cref{lem:iterate-apex}
%for $H$ is $2$-independent in $H$, and hence the corresponding 
%subset $B\subseteq A$ of $G$ is $(2r+2)$-independent. 
%in $G$. 
%\end{proof}

\begin{proof}[of \cref{thm:new-uqw}]
Without loss of generality suppose $m\geq t$.
Define $Q(m,i)$ as follows: $$Q(m,0)=m\quad\textrm{and}\quad Q(m,i)=\max \left (R(Q(i-1),t),\binom{Q(i-1)+t-2}{t-1}\right)\textrm{ for }i>0.$$
Since $R(n,t)\in \Theta_{t}(n^{6t+3})$ and $\binom{n+t-2}{t-1}\in \Theta_t(n^{t-1})$, it can be easily seen that $Q(m,r)\in \Theta_{r,t}(m^{(6t+3)^r})$.
We set $N(m)=Q(m,r)$, so suppose we are given a vertex subset $A$ of size at least $Q(m,r)$.

We now proceed in $r$ rounds, applying \cref{lem:ramsey1} and \cref{lem:iterate-apex} alternately.
Precisely, we construct sets $S_0\subseteq S_1\subseteq \ldots\subseteq S_r$ and $A_0\supseteq A_1\supseteq \ldots\supseteq A_r$, where $S_0=\emptyset$ and $A_0=A$.
We maintain the invariant that $|S_i|\leq \lfloor i/2\rfloor$, $|A_i|\geq Q(m,r-i)$, and $A_i$ is $i$-independent in $G-S_i$. This is clearly satisfied for $i=0$, so we need to describe the construction
of $(A_i,S_i)$ based on $(A_{i-1},S_{i-1})$ for $i>0$.

Suppose first $i=2s$ for some integer $s$. Then apply \cref{lem:ramsey1} to $A_i$ in $G-S_i$, yielding its subset $A_{i+1}$ of size at least $Q(m,r-i-1)$ that is $(i+1)$-independent in $G-S_i$. We may set $S_{i+1}=S_i$
and proceed with the construction.

Suppose now $i=2s+1$ for some integer $s$; then $i<r$ implies that $s\leq r/2-1$, so $K_{t}\not\minor_{3s+2} G$. 
Hence we may apply \cref{lem:iterate-apex} to $A_i$ in $G-S_i$, yielding subsets $R_{s}\subseteq V(G)-S_i$ and $A_{i+1}\subseteq A_i$ 
such that $|R_{s}|\leq t$, $|A_{i+1}|\geq Q(m,r-i-1)$, each vertex of $A_{i+1}$ is at distance exactly $i+1$ from each vertex of $R_s$, and $A_{i+1}$ is $(i+1)$-independent in $(G-S_{i})-R_s$.
We may set $S_{i+1}=R_s\cup S_i$ and proceed with the construction.

Thus, after $r$ rounds we obtain subsets $S=S_r$ and $B=A_r$ such that $|B|\geq Q(m,0)=m$ and~$A'$ is $r$-independent in $G-S$. Observe that we have $S=R_1\cup R_2\cup \ldots\cup R_{\lfloor r/2\rfloor}$,
so the trivial upper bound on the size of $S$ is $rt/2$. We claim that in fact we have $|S|<t$; the argument is similar as in the proof of \cref{lem:iterate-apex}.

Suppose $|S|\geq t$ and let $v_1,\ldots,v_t$ be any $t$ distinct vertices of $S$.
Since $m\geq t$, we may arbitrarily choose $a_1,\ldots,a_t$ to be $t$ distinct vertices of $A'$.
Let $Y_i=N^{G-S}_{\lfloor r/2\rfloor}[a_i]$ for $i=1,2,\ldots,t$.
From \cref{lem:iterate-apex} it can be seen by a trivial induction on $s$ that each vertex of $R_s$ has a neighbor in each set $Y_j$, for $i,j\in \{1,2,\ldots,t\}$; 
this is because at step $i=2s+1$ of the construction we remove from the graph only vertices at distance exactly $s+1$ from each $a_j$.
Hence, the sets $X_i=Y_i\cup \{v_i\}$ for $i=1,\ldots,t$ form a depth-$(\lfloor r/2\rfloor+1)$ minor model of $K_t$ in $G$, a contradiction. 
\end{proof}

\paragraph{Algorithm.} We now argue that the proof presented above can be turned into an algorithm that, 
given $G$ and $A$, outputs sets $S$ and $B$ in time $\Oof_{r,t}(|A|^c\cdot |E(G)|)$ for some universal constant~$c$.
This boils down to implementing each step of the iterative construction from the proof.

The even steps---from $(S_{2s},A_{2s})$ to $(S_{2s+1},A_{2s+1})$---are easy, as we only have to apply Ramsey's theorem in a graph with $A$ as the vertex set, where two vertices are adjacent if and only
if they are at distance $2s$ in $G$. The distances between vertices of $A$ can be computed in time $\Oof(|A|\cdot |E(G)|)$ by running a breadth-first search from each vertex of $A$, and afterwards it remains
to emulate the proof of Ramsey's theorem algorithmically on a graph with $|A|$ vertices, which can be done in time polynomial in $|A|$.

For the odd steps---from $(S_{2s+1},A_{2s+1})$ to $(S_{2s+2},A_{2s+2})$---we need to implement algorithmically the proof of \cref{lem:iterate-apex}. 
This boils down to implementing algorithmically the proof of \cref{lem:apex}, since
the proof of \cref{lem:iterate-apex} essentially consists of applying \cref{lem:apex} at most $t$ times. For \cref{lem:apex}, we can construct the distance-$(2s+2)$ tree $T$ of $A$ in time
$\Oof(|A|\cdot |E(G)|)$, as this again only requires precomputing distances between vertices of $A$ using breadth-first search from each vertex of $A$.
Afterwards we examine the longest root-to-leaf path in $T$, which has to have length at least $2m^3$, and we classify its vertices into red and blue, as in the proof. If more than half of the vertices are red,
then they form a $(2s+2)$-independent set that can be output by the algorithm. Otherwise, the proof argues that there is vertex $v$ in the graph that is at distance exactly $s+1$ from at least $m$ blue vertices.
Such a vertex can be found by computing in time $\Oof(|A|\cdot |E(G)|)$ the distances between each blue vertex and each vertex $v\in V(G)$, again using breadth-first search from each blue vertex, and selecting
a vertex $v$ for which the number of blue vertices at distance exactly $s+1$ from $v$ is at least $m$. 


\section{VC dimension}\label{sec:vc}

We now come to the proof of \cref{thm:new-vc}. A set $X$ of vertices 
in a graph is \emph{shattered} if for every
subset $Y\subseteq X$ there exists 
a vertex $v$ such that $N[v]\cap X=Y$. The \emph{Vapnik-Chervonenkis dimension}, short \emph{VC-dimension}~\cite{chervonenkis1971theory} of a graph is the maximum size of a shattered set. 
The VC-dimension as a measure of complexity of set systems found has many applications, e.g.\ in learnability theory~\cite{haussler1987}, computational geometry~\cite{chazelle1989quasi},
and graph theory~\cite{alon2006dominating,BousquetT15,chepoi2007covering,eickmeyer2016neighborhood}.
We define notions of a {\em{$2$-shattered}} set and the {\em{2VC-dimension}} of a graph by restricting subsets $Y\subseteq X$ considered in the definition only to subsets of size exactly $2$.

The \emph{$r$th power of a graph $G$} is the graph $G^r$
with vertex set $V(G)$, where there is an edge between two 
vertices $u$ and $v$ if and only if their distance in $G$ is at most $r$. 

We observe that an argument of Bousquet and 
Thomass\'e~\cite{BousquetT15} can be slightly modified to prove that 
the $2$VC-dimension of the $r$-power graph $G^r$ of a graph $G$
with $K_t\not\minor_r G$ is small. Obviously, the $2$VC-dimension of $G$
bounds its VC-dimension. Hence, we in fact prove the following strengthening of \cref{thm:new-vc} stated in the introduction. 

\begin{theorem}
Let $r\in \N$ and let $G$ be a graph. 
If $K_t\not\minor_r G$, then the $2$VC-dimension of $G^r$
is at most $t-1$. 
\end{theorem}
\begin{proof}
Assume there is a set $A=\{a_1,\ldots, a_t\}$ of size $t$ such that
for all subsets $\{i,j\}\subseteq \{1,\ldots,t\}$ of size $2$ 
there is an vertex $v_{ij}$ with 
$N_r[v_{ij}]\cap A=\{a_i,a_j\}$.
For each subset $\{i,j\}\subseteq \{1,\ldots,t\}$ of size $2$, choose a vertex $u_{ij}$ so that:
\begin{enumerate}[(1)]
\item\label{p:i} $\dist(v_{ij},u_{ij})+\dist(u_{ij},a_i)\leq r$;
\item\label{p:j} $\dist(v_{ij},u_{ij})+\dist(u_{ij},a_j)\leq r$; and
\item\label{p:min} subject to conditions \eqref{p:i} and \eqref{p:j}, $\max(\dist(u_{ij},a_i),\dist(u_{ij},a_j))$ is minimized.
\end{enumerate}
Observe that $u_{ij}$ is well-defined since setting $u_{ij}=v_{ij}$ satisfies the first two conditions.

Let $P^i_{ij}$ and $P^j_{ij}$ be arbitrarily chosen shortest paths between $u_{ij}$ and~$a_i$, and between $u_{ij}$ and~$a_j$, respectively.
We now establish some basic properties of paths $P^i_{ij}$ and $P^j_{ij}$ following from the choice of $u_{ij}$.

\begin{claim}\label{cl:ineq}
For each vertex $x$ on $P^i_{ij}$ we have $\dist(v_{ij},x)+\dist(x,a_i)\leq r$, and
for each vertex $y$ on $P^j_{ij}$ we have $\dist(v_{ij},y)+\dist(y,a_j)\leq r$.
\end{claim}
\begin{clproof}
We prove only the first statement for the second is symmetric.
We have
$$\dist(v_{ij},x)+\dist(x,a_{i})\leq \dist(v_{ij},u_{ij})+\dist(u_{ij},x)+\dist(x,a_{i})=\dist(v_{ij},u_{ij})+\dist(u_{ij},a_{i})\leq r,$$
where the last equality is due to $x$ lying on a shortest path between $u_{ij}$ and $a_i$, and the last inequality is by condition~\eqref{p:i}.
\end{clproof}

\begin{claim}\label{cl:closer}
Suppose $x$ is a vertex on $P^i_{ij}$ that is different from $u_{ij}$. Then $\dist(x,a_i)<\dist(x,a_j)$.
Symmetrically, if $y$ lies on $P^j_{ij}$ and is different from $u_{ij}$, then $\dist(y,a_i)>\dist(y,a_j)$.
Consequently, paths $P^i_{ij}$ and $P^j_{ij}$ share only one vertex, being the endpoint $u_{ij}$.
\end{claim}
\begin{clproof}
We prove only the first claim, for the second is symmetric and the third directly follows from the first two.
Suppose for contradiction that $\dist(x,a_i)\geq \dist(x,a_j)$.
By \cref{cl:ineq} we have 
$$\dist(v_{ij},x)+\dist(x,a_i)\leq r.$$
On the other hand, since $\dist(x,a_i)\geq \dist(x,a_j)$, we have
$$\dist(v_{ij},x)+\dist(x,a_j)\leq\dist(v_{ij},x)+\dist(x,a_i)\leq r.$$
We conclude that $x$ satisfies conditions \eqref{p:i} and \eqref{p:j} from the definition of $u_{ij}$.
However, since $x\neq u_{ij}$ and $x$ lies on a shortest path between $u_{ij}$ and $a_i$, we have $\dist(x,a_i)<\dist(u_{ij},a_i)$.
Therefore,
$$\dist(x,a_j)\leq \dist(x,a_i)<\dist(u_{ij},a_i)\leq \max(\dist(u_{ij},a_i),\dist(u_{ij},a_j)).$$
Thus, the existence of $x$ contradicts condition \eqref{p:min} from the definition of $u_{ij}$.
\end{clproof}

Now, define paths $Q^i_{ij}$ and $Q^j_{ij}$ as follows:
\begin{itemize}
\item if $\dist(u_{ij},a_i)<\dist(u_{ij},a_j)$, then $Q^{i}_{ij}=P^{i}_{ij}$ and $Q^{j}_{ij}=P^{j}_{ij} - \{u_{ij}\}$;
\item if $\dist(u_{ij},a_i)>\dist(u_{ij},a_j)$, then $Q^{i}_{ij}=P^{i}_{ij} - \{u_{ij}\}$ and $Q^{j}_{ij}=P^{j}_{ij}$;
\item if $\dist(u_{ij},a_i)=\dist(u_{ij},a_j)$, then define $Q^i_{ij}$ and $Q^j_{ij}$ using any of the above.
\end{itemize}
Thus, by \cref{cl:closer} we have that paths $Q^{i}_{ij}$ and $Q^{j}_{ij}$ are disjoint. Moreover, for each vertex $x$ on $Q^{i}_{ij}$ we have $\dist(x,a_i)\leq \dist(x,a_j)$, and for each
vertex $y$ on $Q^{j}_{ij}$ we have $\dist(y,a_i)\geq \dist(y,a_j)$.

\begin{claim}\label{cl:intersect}
Let $\{i,j\}$ and $\{i',j'\}$ be two different subsets of size $2$ of $\{1,\ldots,t\}$.
Suppose that paths $Q^i_{ij}$ and $Q^{i'}_{i'j'}$ intersect.
Then $i=i'$.
\end{claim}
\begin{clproof}
Let $x$ be a vertex lying both on $Q^i_{ij}$ and $Q^{i'}_{i'j'}$. We first consider the corner case when $x=u_{ij}$.
Suppose first that $\dist(v_{ij},x)\geq \dist(v_{i'j'},x)$. Then by \cref{cl:ineq} we have
$$\dist(v_{i'j'},a_i)\leq \dist(v_{i'j'},x)+\dist(x,a_i)\leq \dist(v_{ij},x)+\dist(x,a_i)\leq r,$$
and analogously $\dist(v_{i'j'},a_{j})\leq r$. However, we assumed that $a_{i'}$ and $a_{j'}$ are the only vertices of~$A$ that are at distance at most $r$ from $v_{i'j'}$, hence $\{i,j\}=\{i',j'\}$,
a contradiction. Suppose then that $\dist(v_{ij},x)<\dist(v_{i'j'},x)$. 
Then we have
$$\dist(v_{ij},a_{i'})\leq \dist(v_{ij},x)+\dist(x,a_{i'})<\dist(v_{i'j'},x)+\dist(x,a_{i'})\leq r,$$
where the last equality follows from \cref{cl:ineq}.
Since $a_i$ and $a_j$ are the only vertices of $A$ that are at distance at most $r$ from $v_{ij}$, we infer that $i'\in \{i,j\}$. 
If $i'=i$ then we would be done, so suppose $i'=j$.
Since $x=u_{ij}$ and $x$ lies on $Q^i_{ij}$, by the definition of $Q^i_{ij}$ we have that $\dist(x,a_i)\leq \dist(x,a_j)=\dist(x,a_{i'})$. Therefore,
$$\dist(v_{i'j'},a_i)\leq \dist(v_{i'j'},x)+\dist(x,a_{i})\leq \dist(v_{i'j'},x)+\dist(x,a_{i'})\leq r.$$
where the last inequality follows from \cref{cl:ineq}.
Again, we assumed that $a_{i'}$ and $a_{j'}$ are the only vertices of $A$ that are at distance at most $r$ from $v_{i'j'}$, so $i\in \{i',j'\}$. If $i=i'$ then we are done, and otherwise we have $i=j'$.
Together with $i'=j$ this implies $\{i,j\}=\{i',j'\}$, a contradiction.

The second corner case when $x=u_{i'j'}$ leads to a contradiction in a symmetric manner.

We now move to the main case when $x\neq u_{ij}$ and $x\neq u_{i'j'}$.
Then by \cref{cl:closer} we have $\dist(x,a_i)<\dist(x,a_j)$ and $\dist(x,a_{i'})<\dist(x,a_{j'})$.
By symmetry, without loss of generality assume that $\dist(x,a_i)\leq \dist(x,a_{i'})$.
Observe now that
$$\dist(v_{i'j'},a_i)\leq \dist(v_{i'j'},x)+\dist(x,a_{i})\leq \dist(v_{i'j'},x)+\dist(x,a_{i'})\leq r,$$
where the last inequality follows from \cref{cl:ineq}.
Since we assumed that $a_{i'}$ and $a_{j'}$ are the only vertices of $A$ that are at distance at most $r$ from $v_{i'j'}$, we have $i\in \{i',j'\}$.
However, it cannot happen that $i=j'$, because $\dist(x,a_{i'})<\dist(x,a_{j'})$ and $\dist(x,a_{i'})\geq \dist(x,a_{i})$. We conclude that $i=i'$.
\end{clproof}

For each $i\in \{1,2,\ldots,t\}$ we define $X_i$ to be the union of vertex sets of paths $Q^i_{ij}$ for $j\neq i$.
Each of these paths has length at most $r$ and has $a_i$ as an endpoint, hence the subgraph induced by $X_i$ is connected and has radius at most $r$.
By \cref{cl:intersect}, sets $X_i$ are pairwise disjoint. Finally, observe that for each $\{i,j\}\subseteq \{1,\ldots,t\}$ with $i\neq j$, there is an edge between a vertex of $Q^{i}_{ij}$ and a vertex of $Q^{j}_{ij}$.
We conclude that $(X_i)_{i=1,\ldots,t}$ is a depth-$r$ minor model of $K_t$ in $G$, a contradiction.
\end{proof}

\begin{comment}
\begin{proof}
Assume there is a set $A=\{a_1,\ldots, a_t\}$ of size $t$ such that
for all subsets $\{a_i,a_j\}\subseteq A$ of size $2$ 
there is an element $v_{ij}\in V(G)\setminus A$ with 
$N_r[v_{ij}]\cap A=\{a_i,a_j\}$. Fix such $v_{ij}$ with the property
that $\max\left(\dist_G(v_{ij},a_i), \dist_G(v_{ij},a_j)\right)$ is 
minimized. 

A \emph{central walk} $W_{ij}$ is the concatenation of a minimum length
path $P_{ij}^i$ from $a_i$ to $v_{ij}$ and a minimum length path $P_{ij}^j$ from $v_{ij}$ to $a_j$. 
Note that a central walk is possibly not a path. For each pair $a_i,a_j$ fix
a central walk $W_{ij}$ and the corresponding paths $P_{ij}^i$ and $P_{ij}^j$. 

Now assume that a vertex $x$ is traversed by two different central 
walks $W_{ij}$, $W_{i'j'}$. By swapping indices if necessary, assume that $x$ lies on $P_{ij}^i$ and $P_{i'j'}^{i'}$. 

First, observe that if $\dist(x,a_i)=\dist(x,a_{i'})$, 
then $a_i=a_{i'}$. Indeed, if $\dist(x,a_i)=\dist(x,a_{i'})$ then $\dist(v_{ij},a_{i})=\dist(v_{ij},a_{i'})$, so $i'\in \{i,j\}$ because $a_i,a_j$ are the only vertices of $A$ at distance at most $r$ from $v_{ij}$.
Analogously $i\in \{i',j'\}$, so either $i=i'$, or $i'=j$ and $i=j'$. However, the latter case would imply $\{i,j\}=\{i',j'\}$, which contradicts the assumption that $W_{ij}$ and $W_{i'j'}$ are distinct. 

A similar argument yields that
$\dist(x,a_i)<\dist(x,a_j)$ 
and $\dist(x,a_{i'})<\dist(x,a_{j'})$. 
Now assume that $\dist(x,a_i)<\dist(x,a_{i'})$. By the same argument as 
above we have $a_{j'}=a_i$, hence $W_{i'j'}=W_{ij'}$. Here, we have
$\dist(x,a_i)<\dist(x,a_j)$ and $\dist(x,a_{i})<\dist(x,a_{i'})$, 
otherwise the walks are not distinct. 

Let us now construct connected subsets $X_i$ for all $1\leq i\leq t$. 
For every walk $W_{ij}$ the vertices of $W_{ij}$ closer to $a_i$ than to $a_j$ 
are added to $X_i$, the vertices of $W_{ij}$ closer to $a_j$ than to $a_i$ 
are added to $X_j$, ties are broken arbitrary.
Then the sets $X_i$ are pairwise disjoint by what we proved above. If a vertex $x$
appears in two distinct central walks, these are $W_{ij}$ and $W_{i\ell}$ for some
$i,j,\ell$ with $\dist(x,a_i)<\dist(x,a_j)$ and $\dist(x,a_i)<\dist(x,a_\ell)$. 
In both cases $x$ belongs to $X_i$. By construction, the sets $X_i$ are connected, 
have radius at most~$r$, and 
there is always an edge between a vertex of $X_i$ and a vertex of $X_j$ since $X_i\cup X_j$ 
contains the walk $W_{ij}$. Therefore, if the $2$VC-dimension is at least $t$, the 
graph contains $K_t$ as a depth-$r$ minor. 
\end{proof}
\end{comment}